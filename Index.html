<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KI·ªÇM TRA TR·ª∞C TUY·∫æN AN PH√öC EDUCATION</title>
  <style>
    :root { 
      --primary: #1e3a8a; --secondary: #2563eb; --accent: #f59e0b; 
      --bg: #f8fafc; --text: #334155; --white: #ffffff;
    }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
    
    /* Header */
    header { background: var(--primary); color: var(--white); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    h1 { margin: 0; font-size: 1.2rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
    .btn-login { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 15px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
    .btn-login:hover { background: rgba(255,255,255,0.3); }

    /* Tabs */
    .tabs { display: flex; background: var(--white); border-bottom: 2px solid #e2e8f0; }
    .tab-btn { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; transition: 0.3s; }
    .tab-btn:hover { background: #eff6ff; color: var(--secondary); }
    .tab-btn.active { color: var(--secondary); border-bottom-color: var(--secondary); background: #eff6ff; }
    
    /* Layout */
    .main-container { flex: 1; display: flex; overflow: hidden; }
    .sidebar { width: 340px; background: var(--white); border-right: 1px solid #e2e8f0; overflow-y: auto; padding: 15px 10px; display: flex; flex-direction: column; }
    .content-area { flex: 1; padding: 40px; text-align: center; background: #f1f5f9; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }

    /* Tree View */
    ul { list-style: none; padding-left: 20px; margin: 0; }
    li { margin: 2px 0; }
    .caret { cursor: pointer; user-select: none; display: flex; align-items: center; padding: 8px 10px; border-radius: 6px; font-weight: 600; color: #475569; transition: 0.2s; }
    .caret:hover { background: #f1f5f9; color: var(--primary); }
    .caret::before { content: "‚ñ∂"; margin-right: 8px; font-size: 0.75rem; color: #94a3b8; transition: 0.2s; }
    .caret-down::before { transform: rotate(90deg); color: var(--secondary); }
    .nested { display: none; margin-left: 8px; border-left: 2px solid #e2e8f0; }
    .active { display: block; }
    .item-leaf { cursor: pointer; padding: 8px 12px; display: block; color: #475569; border-radius: 6px; font-size: 0.95rem; margin: 2px 0; transition: 0.2s; }
    .item-leaf:hover { background: #dbeafe; color: var(--primary); font-weight: 500; }
    .item-leaf.selected { background: var(--secondary); color: white; font-weight: 600; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }
    .special-node > span { color: #db2777; font-weight: 700; }

    /* Exam Card */
    .exam-card { background: var(--white); padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); width: 100%; max-width: 700px; display: none; }
    .exam-title { color: var(--primary); margin: 0 0 10px 0; font-size: 1.8rem; }
    .exam-subtitle { color: #64748b; margin-bottom: 30px; }
    
    /* Code List */
    .code-list { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-bottom: 30px; }
    .code-wrapper { position: relative; }
    .code-btn { 
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: #f8fafc; border: 2px solid #e2e8f0; padding: 15px 25px; 
      border-radius: 10px; text-decoration: none; color: var(--text); cursor: pointer; transition: 0.2s;
      min-width: 120px; user-select: none;
    }
    .code-btn span.icon { font-size: 1.5rem; margin-bottom: 5px; }
    .code-btn b { font-size: 1.1rem; color: var(--primary); }
    .code-btn:hover { border-color: var(--secondary); background: #eff6ff; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(37, 99, 235, 0.15); }
    .code-btn.empty { border-style: dashed; color: #94a3b8; cursor: default; transform: none; box-shadow: none; }
    
    /* Delete Button */
    .btn-delete-code {
        position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border: none;
        width: 24px; height: 24px; border-radius: 50%; font-weight: bold; cursor: pointer;
        display: none; align-items: center; justify-content: center; font-size: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .code-wrapper:hover .btn-delete-code.show { display: flex; }

    /* Admin Panel */
    .admin-panel { margin-top: 30px; padding: 25px; border-top: 2px dashed #e2e8f0; display: none; text-align: left; background: #fffbeb; border-radius: 10px; border: 1px solid #fcd34d; }
    .admin-panel.show { display: block; animation: fadeIn 0.3s; }
    .admin-header { font-size: 1rem; font-weight: 700; color: #b45309; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    
    .input-row { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
    .input-row label { min-width: 100px; font-weight: 600; color: #78350f; }
    input[type="text"] { flex: 1; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem; transition: 0.2s; }
    input[type="text"]:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2); }
    
    button.btn-admin { border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; transition: 0.2s; white-space: nowrap; }
    .btn-save { background: #f59e0b; } .btn-save:hover { background: #d97706; }
    .btn-add { background: #10b981; } .btn-add:hover { background: #059669; }
    .btn-create { background: #ef4444; } .btn-create:hover { background: #dc2626; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .placeholder-state { margin-top: 100px; color: #94a3b8; font-size: 1.1rem; display: flex; flex-direction: column; align-items: center; }
    .placeholder-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }
    
    /* Loading overlay */
    #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; justify-content:center; align-items:center; font-size:1.2rem; color:var(--primary); z-index:1000; }
  </style>
</head>
<body>

<div id="loading">ƒêang k·∫øt n·ªëi d·ªØ li·ªáu...</div>

<header>
  <h1>KI·ªÇM TRA TR·ª∞C TUY·∫æN AN PH√öC EDUCATION</h1>
  <button class="btn-login" id="loginBtn" onclick="toggleLogin()">üîí GV ƒêƒÉng nh·∫≠p</button>
</header>

<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('regular')">Ki·ªÉm tra Th∆∞·ªùng xuy√™n</button>
  <button class="tab-btn" onclick="switchTab('periodic')">Ki·ªÉm tra ƒê·ªãnh k·ª≥ & Cu·ªëi c·∫•p</button>
</div>

<div class="main-container">
  <div class="sidebar" id="sidebarContent"></div>
  
  <div class="content-area">
    <div id="placeholder" class="placeholder-state">
      <div class="placeholder-icon">üëà</div>
      <div>Vui l√≤ng ch·ªçn b√†i thi t·ª´ danh s√°ch b√™n tr√°i</div>
    </div>
    
    <div id="examCard" class="exam-card">
      <h2 id="examTitle" class="exam-title">T√™n ƒê·ªÅ Thi</h2>
      <div class="exam-subtitle">Click v√†o m√£ ƒë·ªÅ ƒë·ªÉ <b>COPY</b>, sau ƒë√≥ link b√†i thi s·∫Ω m·ªü ra:</div>
      
      <div id="codeList" class="code-list"></div>

      <div id="adminPanel" class="admin-panel">
        <div class="admin-header">üõ†Ô∏è KHU V·ª∞C GI√ÅO VI√äN</div>
        <div class="input-row" id="editNameRow">
           <label>T√™n b√†i thi:</label>
           <input type="text" id="editNameInput">
           <button class="btn-admin btn-save" onclick="saveName()">L∆∞u T√™n</button>
        </div>
        <div class="input-row">
           <label>Th√™m m√£ ƒë·ªÅ:</label>
           <input type="text" id="addCodeInput" placeholder="VD: DE-02, MA-LE...">
           <button class="btn-admin btn-add" onclick="addCode()">+ Th√™m M√£</button>
        </div>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #fcd34d;">
        <div style="font-weight:bold; color:#b45309; margin-bottom:10px;">‚ûï T·∫†O ƒê·ªÄ THI M·ªöI (V√†o m·ª•c ƒëang ch·ªçn)</div>
        <div class="input-row">
           <input type="text" id="createExamName" placeholder="T√™n ƒë·ªÅ m·ªõi (VD: ƒê·ªÅ thi th·ª≠ s·ªë 5)">
        </div>
        <div class="input-row">
           <input type="text" id="createExamCode" placeholder="M√£ ƒë·ªÅ (VD: THU-05)">
           <button class="btn-admin btn-create" onclick="createNewExam()">T·∫°o Ngay</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // D√ÅN LINK WEB APP (ƒêU√îI /exec) C·ª¶A TH·∫¶Y V√ÄO ƒê√ÇY:
  const API_BASE = "https://script.google.com/macros/s/AKfycbx3ywmCUbcyX9htsH9zy7yFldHPt17zb9tPezbLlq8RjLbS_xmsbQWdVLwBi79h30cX/exec";
  const REDIRECT_BASE = API_BASE; 

  let regularData = [], periodicData = [], isAdmin = false, currentTab = 'regular', currentItem = null;

  async function init() {
    try {
      const [regRes, perRes] = await Promise.all([
        fetch(API_BASE + "?action=getRegular").then(r => r.json()),
        fetch(API_BASE + "?action=getPeriodic").then(r => r.json())
      ]);
      regularData = regRes;
      periodicData = perRes;
      document.getElementById('loading').style.display = 'none';
      renderSidebar();
    } catch(e) {
      alert("L·ªói t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra l·∫°i Link Apps Script!");
    }
  }
  
  window.onload = init;

  function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    renderSidebar();
    document.getElementById('examCard').style.display = 'none';
    document.getElementById('placeholder').style.display = 'flex';
    currentItem = null;
  }

  function renderSidebar() {
    const root = document.getElementById('sidebarContent');
    root.innerHTML = "";
    if (currentTab === 'regular') renderRegularSidebar(root);
    else renderPeriodicSidebar(root);
  }

  function renderRegularSidebar(root) {
    const tree = {};
    regularData.forEach(item => {
      if (!tree[item.grade]) tree[item.grade] = {};
      if (!tree[item.grade][item.chapter]) tree[item.grade][item.chapter] = [];
      tree[item.grade][item.chapter].push(item);
    });
    root.appendChild(buildTreeDOM(tree));
  }

  function renderPeriodicSidebar(root) {
    const order = ["To√°n 6", "To√°n 7", "To√°n 8", "To√°n 9", "TS10", "To√°n 10", "To√°n 11", "To√°n 12", "TNTHPT"];
    const grouped = {};
    periodicData.forEach(item => {
      if (!grouped[item.category]) grouped[item.category] = [];
      grouped[item.category].push(item);
    });
    const ul = document.createElement('ul');
    order.forEach(category => {
      if (grouped[category]) {
        let li = document.createElement('li');
        if (category === "TS10" || category === "TNTHPT") li.className = "special-node";
        li.appendChild(createCaret(category));
        let subUl = document.createElement('ul');
        subUl.className = 'nested';
        grouped[category].forEach(exam => {
          let subLi = document.createElement('li');
          subLi.className = 'item-leaf';
          subLi.innerText = exam.displayName;
          subLi.onclick = () => selectExam(exam, 'periodic');
          subUl.appendChild(subLi);
        });
        li.appendChild(subUl);
        ul.appendChild(li);
      }
    });
    root.appendChild(ul);
  }

  function buildTreeDOM(tree) {
    const ul = document.createElement('ul');
    for (let grade in tree) {
      let li = document.createElement('li');
      li.appendChild(createCaret(grade));
      let chapUl = document.createElement('ul');
      chapUl.className = 'nested';
      for (let chap in tree[grade]) {
        let chapLi = document.createElement('li');
        chapLi.appendChild(createCaret(chap));
        let lessonUl = document.createElement('ul');
        lessonUl.className = 'nested';
        tree[grade][chap].forEach(lesson => {
           let lessonLi = document.createElement('li');
           lessonLi.className = 'item-leaf';
           lessonLi.innerText = lesson.lesson;
           lessonLi.onclick = () => selectExam(lesson, 'regular');
           lessonUl.appendChild(lessonLi);
        });
        chapLi.appendChild(lessonUl);
        chapUl.appendChild(chapLi);
      }
      li.appendChild(chapUl);
      ul.appendChild(li);
    }
    return ul;
  }

  function createCaret(text) {
    let span = document.createElement('span');
    span.className = 'caret';
    span.innerText = text;
    span.onclick = function() {
      this.parentElement.querySelector('.nested').classList.toggle('active');
      this.classList.toggle('caret-down');
    };
    return span;
  }

  function selectExam(item, type) {
    currentItem = item;
    currentItem.dataType = type;
    document.querySelectorAll('.item-leaf').forEach(el => el.classList.remove('selected'));
    event.target.classList.add('selected');
    document.getElementById('placeholder').style.display = 'none';
    document.getElementById('examCard').style.display = 'block';
    document.getElementById('examTitle').innerText = item.displayName || item.lesson;
    renderCodeButtons(item.code);
    updateAdminUI();
  }

  function renderCodeButtons(codeString) {
    const list = document.getElementById('codeList');
    list.innerHTML = "";
    
    if (!codeString) {
      list.innerHTML = `<div class="code-btn empty"><span>üì≠</span><b>Ch∆∞a c√≥ m√£ ƒë·ªÅ</b></div>`;
      return;
    }

    const codes = codeString.toString().split(',').map(c => c.trim()).filter(c => c);
    
    codes.forEach((code) => {
      let wrapper = document.createElement('div');
      wrapper.className = 'code-wrapper';

      let btn = document.createElement('div');
      btn.className = 'code-btn';
      btn.title = "Click ƒë·ªÉ Copy m√£ r·ªìi v√†o thi";
      btn.innerHTML = `<span class="icon">üìù</span><b>${code}</b>`;
      
      btn.onclick = function() {
        navigator.clipboard.writeText(code).then(() => {
           if(confirm(`ƒê√£ copy m√£: ${code}\n\nNh·∫•n OK ƒë·ªÉ m·ªü trang b√†i thi.`)) {
               window.open(REDIRECT_BASE + "?code=" + encodeURIComponent(code), '_blank');
           }
        });
      };
      
      let deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn-delete-code ' + (isAdmin ? 'show' : '');
      deleteBtn.innerText = "X";
      deleteBtn.title = "X√≥a m√£ ƒë·ªÅ n√†y";
      deleteBtn.onclick = (e) => { e.stopPropagation(); deleteCode(code); };

      wrapper.appendChild(btn);
      wrapper.appendChild(deleteBtn);
      list.appendChild(wrapper);
    });
  }

  async function deleteCode(codeToDelete) {
    if(!confirm(`X√≥a m√£ ƒë·ªÅ "${codeToDelete}"?`)) return;
    
    let currentCodes = currentItem.code.toString().split(',').map(c => c.trim()).filter(c => c);
    let newCodes = currentCodes.filter(c => c !== codeToDelete);
    let newCodeString = newCodes.join(", ");
    
    const sheetName = currentItem.dataType === 'periodic' ? 'PeriodicData' : 'RegularData';
    const url = `${API_BASE}?action=updateCode&sheet=${sheetName}&row=${currentItem.row}&code=${encodeURIComponent(newCodeString)}`;
    
    await fetch(url);
    alert("ƒê√£ x√≥a m√£ ƒë·ªÅ!");
    currentItem.code = newCodeString;
    renderCodeButtons(newCodeString);
  }

  function updateAdminUI() {
    if (isAdmin) {
      document.getElementById('adminPanel').classList.add('show');
      if (currentItem.dataType === 'periodic') {
        document.getElementById('editNameRow').style.display = 'flex';
        document.getElementById('editNameInput').value = currentItem.displayName || "";
      } else {
        document.getElementById('editNameRow').style.display = 'none';
      }
      document.querySelectorAll('.btn-delete-code').forEach(b => b.classList.add('show'));
    } else {
      document.getElementById('adminPanel').classList.remove('show');
      document.querySelectorAll('.btn-delete-code').forEach(b => b.classList.remove('show'));
    }
  }

  async function toggleLogin() {
    if (!isAdmin) {
      let p = prompt("M·∫≠t kh·∫©u Gi√°o Vi√™n:");
      const res = await fetch(`${API_BASE}?action=login&pass=${p}`).then(r => r.json());
      if(res.valid) {
        isAdmin = true;
        document.getElementById('loginBtn').innerText = "üîì ƒê√£ ƒëƒÉng nh·∫≠p";
        document.getElementById('loginBtn').style.background = "#10b981";
        if (currentItem) updateAdminUI();
        alert("ƒê√£ ƒëƒÉng nh·∫≠p Admin!");
      } else alert("Sai m·∫≠t kh·∫©u!");
    } else {
      isAdmin = false;
      document.getElementById('loginBtn').innerText = "üîí GV ƒêƒÉng nh·∫≠p";
      document.getElementById('loginBtn').style.background = "rgba(255,255,255,0.15)";
      if(currentItem) updateAdminUI();
    }
  }

  async function saveName() {
    const newName = document.getElementById('editNameInput').value;
    if (!newName) return;
    const url = `${API_BASE}?action=updateName&row=${currentItem.row}&newName=${encodeURIComponent(newName)}`;
    await fetch(url);
    alert("ƒê√£ c·∫≠p nh·∫≠t t√™n!");
    currentItem.displayName = newName;
    document.getElementById('examTitle').innerText = newName;
    renderSidebar();
  }

  async function addCode() {
    const newCode = document.getElementById('addCodeInput').value;
    if (!newCode) return;
    let currentCodes = currentItem.code ? currentItem.code + ", " + newCode : newCode;
    
    const sheetName = currentItem.dataType === 'periodic' ? 'PeriodicData' : 'RegularData';
    const url = `${API_BASE}?action=updateCode&sheet=${sheetName}&row=${currentItem.row}&code=${encodeURIComponent(currentCodes)}`;
    
    await fetch(url);
    alert("ƒê√£ th√™m m√£ ƒë·ªÅ!");
    currentItem.code = currentCodes;
    renderCodeButtons(currentCodes);
    document.getElementById('addCodeInput').value = "";
  }

  async function createNewExam() {
    if (!currentItem) { alert("Ch·ªçn nh√≥m tr∆∞·ªõc!"); return; }
    const name = document.getElementById('createExamName').value;
    const code = document.getElementById('createExamCode').value;
    if (!name || !code) { alert("Thi·∫øu th√¥ng tin!"); return; }

    const sheetName = currentTab === 'periodic' ? 'PeriodicData' : 'RegularData';
    const cat = currentItem.category || currentItem.grade; 
    const type = currentItem.examType || currentItem.chapter; 

    if (confirm(`Th√™m ƒë·ªÅ m·ªõi v√†o "${cat}"?`)) {
       const url = `${API_BASE}?action=addExam&sheet=${sheetName}&cat=${encodeURIComponent(cat)}&type=${encodeURIComponent(type)}&name=${encodeURIComponent(name)}&code=${encodeURIComponent(code)}`;
       await fetch(url);
       alert("ƒê√£ t·∫°o ƒë·ªÅ m·ªõi!");
       init(); // Reload data
    }
  }
</script>

</body>
</html>
