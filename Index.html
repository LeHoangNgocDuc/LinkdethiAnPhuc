<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KIá»‚M TRA TRá»°C TUYáº¾N AN PHÃšC EDUCATION</title>
  <style>
    /* DÃ¡n láº¡i CSS cá»§a tháº§y vÃ o Ä‘Ã¢y */
    :root { --primary: #1e3a8a; --bg: #f8fafc; --text: #334155; }
    body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
    header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; }
    .main-container { flex: 1; display: flex; overflow: hidden; }
    .sidebar { width: 300px; background: white; overflow-y: auto; padding: 10px; border-right: 1px solid #ccc; }
    .content-area { flex: 1; padding: 20px; overflow-y: auto; }
    .hidden { display: none; }
    /* ThÃªm cÃ¡c class CSS cÅ© cá»§a tháº§y vÃ o Ä‘Ã¢y Ä‘á»ƒ Ä‘áº¹p */
    .tabs { display: flex; background: white; border-bottom: 1px solid #ccc; }
    .tab-btn { flex: 1; padding: 15px; cursor: pointer; border: none; background: none; font-weight: bold; }
    .tab-btn.active { color: blue; border-bottom: 2px solid blue; }
    .caret { cursor: pointer; display: block; padding: 5px; }
    .nested { display: none; margin-left: 15px; }
    .active { display: block; }
    .item-leaf { cursor: pointer; padding: 5px; color: #555; }
    .item-leaf:hover { color: blue; }
    .code-btn { display: inline-block; padding: 10px; margin: 5px; border: 1px solid #ccc; cursor: pointer; background: white; }
    .code-btn:hover { background: #eee; }
    .admin-panel { margin-top: 20px; padding: 20px; background: #fff3cd; display: none; }
    .admin-panel.show { display: block; }
  </style>
</head>
<body>

<header>
  <h3>AN PHÃšC EDUCATION</h3>
  <button onclick="toggleLogin()" id="loginBtn">ğŸ”’ GV ÄÄƒng nháº­p</button>
</header>

<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('regular')">ThÆ°á»ng xuyÃªn</button>
  <button class="tab-btn" onclick="switchTab('periodic')">Äá»‹nh ká»³ & Cuá»‘i cáº¥p</button>
</div>

<div class="main-container">
  <div class="sidebar" id="sidebarContent">Äang táº£i...</div>
  <div class="content-area">
    <div id="placeholder">ğŸ‘ˆ Chá»n Ä‘á» thi bÃªn trÃ¡i</div>
    
    <div id="examCard" class="hidden">
      <h2 id="examTitle"></h2>
      <div id="codeList"></div>

      <div id="adminPanel" class="admin-panel">
        <h4>Khu vá»±c GiÃ¡o viÃªn</h4>
        <input type="text" id="editNameInput" placeholder="Sá»­a tÃªn Ä‘á»">
        <button onclick="saveName()">LÆ°u TÃªn</button>
        <br><br>
        <input type="text" id="addCodeInput" placeholder="ThÃªm mÃ£ (VD: 102)">
        <button onclick="addCode()">+ ThÃªm MÃ£</button>
        <hr>
        <input type="text" id="newExamName" placeholder="TÃªn Ä‘á» má»›i">
        <input type="text" id="newExamCode" placeholder="MÃ£ Ä‘á» má»›i">
        <button onclick="createNewExam()">Táº¡o Äá» Má»›i</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ==========================================
  // THáº¦Y DÃN LINK WEB APP Cá»¦A THáº¦Y VÃ€O ÄÃ‚Y (PHáº¢I LÃ€ LINK /exec)
  // ==========================================
  const API_BASE = "https://script.google.com/macros/s/AKfycbwyLtxBgS5pBNFiBn0BioVXUvHvN2uUD8-VOWOh0rBH8X_6kRPrPQrPMgme3K5cZrtt/exec";
  
  let regularData = [], periodicData = [], isAdmin = false, currentTab = 'regular', currentItem = null;

  // HÃ€M Gá»ŒI API AN TOÃ€N
  async function callAPI(params) {
    // Chuyá»ƒn object params thÃ nh query string
    const queryString = new URLSearchParams(params).toString();
    try {
      // mode: 'cors' cá»±c ká»³ quan trá»ng
      const response = await fetch(API_BASE + "?" + queryString, { method: "GET", mode: 'cors' });
      const json = await response.json();
      return json;
    } catch (e) {
      console.error("Lá»—i API:", e);
      alert("Lá»—i káº¿t ná»‘i. Tháº§y hÃ£y kiá»ƒm tra láº¡i Link Apps Script Ä‘Ã£ Ä‘á»ƒ cháº¿ Ä‘á»™ 'Anyone' chÆ°a?");
      return null;
    }
  }

  async function init() {
    const regRes = await callAPI({ action: "getRegular" });
    const perRes = await callAPI({ action: "getPeriodic" });
    
    if (regRes && perRes) {
      regularData = regRes;
      periodicData = perRes;
      renderSidebar();
    }
  }
  
  window.onload = init;

  function renderSidebar() {
    const root = document.getElementById('sidebarContent');
    root.innerHTML = "";
    if(currentTab === 'regular') renderTree(regularData, root, true);
    else renderList(periodicData, root);
  }

  // Render CÃ¢y thÆ° má»¥c (ThÆ°á»ng xuyÃªn)
  function renderTree(data, root) {
    const tree = {};
    data.forEach(item => {
      if (!tree[item.grade]) tree[item.grade] = {};
      if (!tree[item.grade][item.chapter]) tree[item.grade][item.chapter] = [];
      tree[item.grade][item.chapter].push(item);
    });

    const ul = document.createElement('ul');
    for (let grade in tree) {
      let li = document.createElement('li');
      li.innerHTML = `<span class="caret" onclick="toggleNested(this)">â–¶ ${grade}</span>`;
      let chapUl = document.createElement('ul');
      chapUl.className = "nested";
      for (let chap in tree[grade]) {
        let chapLi = document.createElement('li');
        chapLi.innerHTML = `<span class="caret" onclick="toggleNested(this)">â–¶ ${chap}</span>`;
        let lessonUl = document.createElement('ul');
        lessonUl.className = "nested";
        tree[grade][chap].forEach(lesson => {
           let lessonLi = document.createElement('li');
           lessonLi.className = "item-leaf";
           lessonLi.innerText = lesson.lesson;
           lessonLi.onclick = () => selectExam(lesson, 'regular');
           lessonUl.appendChild(lessonLi);
        });
        chapLi.appendChild(lessonUl);
        chapUl.appendChild(chapLi);
      }
      li.appendChild(chapUl);
      ul.appendChild(li);
    }
    root.appendChild(ul);
  }

  // Render Danh sÃ¡ch (Äá»‹nh ká»³)
  function renderList(data, root) {
    const order = ["ToÃ¡n 6", "ToÃ¡n 7", "ToÃ¡n 8", "ToÃ¡n 9", "TS10", "ToÃ¡n 10", "ToÃ¡n 11", "ToÃ¡n 12", "TNTHPT"];
    const grouped = {};
    data.forEach(i => { if(!grouped[i.category]) grouped[i.category]=[]; grouped[i.category].push(i); });

    const ul = document.createElement('ul');
    order.forEach(cat => {
      if(grouped[cat]) {
        let li = document.createElement('li');
        li.innerHTML = `<span class="caret" onclick="toggleNested(this)">â–¶ ${cat}</span>`;
        let subUl = document.createElement('ul');
        subUl.className = "nested";
        grouped[cat].forEach(exam => {
           let subLi = document.createElement('li');
           subLi.className = "item-leaf";
           subLi.innerText = exam.displayName;
           subLi.onclick = () => selectExam(exam, 'periodic');
           subUl.appendChild(subLi);
        });
        li.appendChild(subUl);
        ul.appendChild(li);
      }
    });
    root.appendChild(ul);
  }

  function toggleNested(elm) {
    elm.parentElement.querySelector(".nested").classList.toggle("active");
  }

  function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    renderSidebar();
    document.getElementById('examCard').classList.add('hidden');
    document.getElementById('placeholder').style.display = 'block';
  }

  function selectExam(item, type) {
    currentItem = item;
    currentItem.dataType = type;
    document.getElementById('placeholder').style.display = 'none';
    document.getElementById('examCard').classList.remove('hidden');
    document.getElementById('examTitle').innerText = item.displayName || item.lesson;
    renderCodes(item.code);
    updateAdminUI();
  }

  function renderCodes(codeStr) {
    const div = document.getElementById('codeList');
    div.innerHTML = "";
    if(!codeStr) return;
    const codes = codeStr.toString().split(',').map(c=>c.trim()).filter(c=>c);
    
    codes.forEach(code => {
      let btn = document.createElement('div');
      btn.className = "code-btn";
      btn.innerHTML = `ğŸ“ <b>${code}</b> ` + (isAdmin ? `<span onclick="deleteCode('${code}', event)" style="color:red;font-weight:bold;margin-left:5px">X</span>` : "");
      btn.onclick = () => {
         navigator.clipboard.writeText(code);
         if(confirm(`ÄÃ£ copy mÃ£: ${code}. Má»Ÿ link thi?`)) window.open(API_BASE + "?code=" + encodeURIComponent(code), "_blank");
      };
      div.appendChild(btn);
    });
  }

  // --- ADMIN FUNCTIONS ---
  async function toggleLogin() {
    let p = prompt("Pass:");
    let res = await callAPI({ action: "login", pass: p });
    if(res && res.valid) { isAdmin = true; updateAdminUI(); alert("ÄÃ£ Ä‘Äƒng nháº­p!"); }
    else alert("Sai pass");
  }

  function updateAdminUI() {
    const panel = document.getElementById('adminPanel');
    const btn = document.getElementById('loginBtn');
    if(isAdmin) {
      panel.classList.add('show');
      btn.innerText = "ğŸ”“ ÄÃ£ má»Ÿ";
      if(currentItem) renderCodes(currentItem.code); // Re-render to show delete btn
    } else {
      panel.classList.remove('show');
    }
  }

  async function saveName() {
    let name = document.getElementById('editNameInput').value;
    if(!name) return;
    await callAPI({ action: "updateName", row: currentItem.row, newName: name });
    currentItem.displayName = name;
    document.getElementById('examTitle').innerText = name;
    renderSidebar();
    alert("ÄÃ£ sá»­a tÃªn!");
  }

  async function addCode() {
    let code = document.getElementById('addCodeInput').value;
    if(!code) return;
    let newCodes = currentItem.code ? currentItem.code + "," + code : code;
    await callAPI({ action: "updateCode", sheet: currentItem.dataType==='periodic'?'PeriodicData':'RegularData', row: currentItem.row, code: newCodes });
    currentItem.code = newCodes;
    renderCodes(newCodes);
    alert("ÄÃ£ thÃªm mÃ£!");
  }

  async function deleteCode(codeDel, e) {
    e.stopPropagation();
    if(!confirm("XÃ³a mÃ£ nÃ y?")) return;
    let codes = currentItem.code.split(',').map(c=>c.trim()).filter(c=>c!=codeDel);
    let newCodes = codes.join(",");
    await callAPI({ action: "updateCode", sheet: currentItem.dataType==='periodic'?'PeriodicData':'RegularData', row: currentItem.row, code: newCodes });
    currentItem.code = newCodes;
    renderCodes(newCodes);
  }

  async function createNewExam() {
    let name = document.getElementById('newExamName').value;
    let code = document.getElementById('newExamCode').value;
    if(!name) return;
    let cat = currentItem.category || currentItem.grade;
    let type = currentItem.examType || currentItem.chapter;
    await callAPI({ action: "addExam", sheet: currentItem.dataType==='periodic'?'PeriodicData':'RegularData', cat: cat, type: type, name: name, code: code });
    alert("ÄÃ£ táº¡o Ä‘á» má»›i!");
    init(); // Reload
  }
</script>

</body>
</html>