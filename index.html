<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>KI·ªÇM TRA TR·ª∞C TUY·∫æN - AN PH√öC EDUCATION</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
    /* --- 1. C·∫§U H√åNH C∆† B·∫¢N --- */
    :root { 
      --primary: #1e40af; /* Xanh ƒë·∫≠m */
      --secondary: #3b82f6; /* Xanh s√°ng */
      --accent: #f59e0b; /* Cam nh·∫•n */
      --bg: #f3f4f6; 
      --text: #1f2937;
      --text-light: #6b7280;
      --white: #ffffff;
      --border: #e5e7eb;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body { 
      font-family: 'Roboto', sans-serif; 
      background: var(--bg); 
      color: var(--text); 
      margin: 0; 
      padding: 0;
      display: flex; 
      flex-direction: column; 
      height: 100vh; 
      overflow: hidden; /* Ch·∫∑n cu·ªôn trang ch√≠nh */
    }
    
    /* --- 2. HEADER & LOGO --- */
    header { 
      background: var(--white); 
      padding: 10px 15px; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      border-bottom: 1px solid var(--border);
      height: 70px;
      flex-shrink: 0;
    }

    .brand { display: flex; align-items: center; gap: 12px; }
    
    .brand img { 
      height: 45px; 
      width: 45px; 
      object-fit: cover; 
      border-radius: 50%; 
      border: 2px solid var(--secondary);
    }
    
    .brand h1 { 
      margin: 0; 
      font-size: 1.1rem; 
      font-weight: 700; 
      color: var(--primary); 
      text-transform: uppercase; 
      line-height: 1.2;
    }
    
    .brand h1 span { font-size: 0.8rem; color: var(--text-light); display: block; font-weight: 500; text-transform: none; }

    .btn-login { 
      background: #eff6ff; 
      color: var(--primary); 
      border: 1px solid #bfdbfe; 
      padding: 8px 12px; 
      border-radius: 8px; 
      font-size: 0.85rem; 
      font-weight: 600; 
      cursor: pointer; 
      transition: 0.2s;
      white-space: nowrap;
    }
    .btn-login:active { transform: scale(0.95); }

    /* --- 3. TABS --- */
    .tabs { 
      display: flex; 
      background: var(--white); 
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .tab-btn { 
      flex: 1; 
      padding: 14px; 
      border: none; 
      background: none; 
      font-size: 0.95rem; 
      font-weight: 600; 
      color: var(--text-light); 
      cursor: pointer; 
      position: relative;
    }
    .tab-btn.active { color: var(--secondary); background: #f8fafc; }
    .tab-btn.active::after {
      content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: var(--secondary);
    }

    /* --- 4. LAYOUT CH√çNH --- */
    .main-container { 
      flex: 1; 
      display: flex; 
      overflow: hidden; 
      position: relative;
    }

    /* SIDEBAR (Menu tr√°i) */
    .sidebar { 
      width: 350px; 
      background: var(--white); 
      border-right: 1px solid var(--border); 
      overflow-y: auto; 
      padding: 10px; 
      display: flex; 
      flex-direction: column;
    }

    /* CONTENT (N·ªôi dung ph·∫£i) */
    .content-area { 
      flex: 1; 
      padding: 20px; 
      background: #f1f5f9; 
      overflow-y: auto; 
      display: flex; 
      flex-direction: column; 
      align-items: center;
    }

    /* --- 5. TREE VIEW (C√¢y th∆∞ m·ª•c) --- */
    ul { list-style: none; padding-left: 15px; margin: 0; }
    li { margin-bottom: 2px; }
    
    .caret { 
      display: flex; align-items: center; padding: 10px; 
      border-radius: 6px; font-weight: 600; color: #4b5563; 
      cursor: pointer; transition: 0.2s; user-select: none;
    }
    .caret:hover { background: #f3f4f6; color: var(--primary); }
    .caret::before { content: "‚ñ∂"; margin-right: 8px; font-size: 0.7rem; color: #9ca3af; transition: 0.2s; }
    .caret-down::before { transform: rotate(90deg); color: var(--secondary); }
    
    .nested { display: none; margin-left: 8px; border-left: 2px solid #e5e7eb; }
    .active { display: block; }
    
    .item-leaf { 
      padding: 12px 10px; margin: 4px 0; 
      border-radius: 6px; font-size: 0.95rem; color: #374151; 
      cursor: pointer; transition: 0.2s; 
      background: white;
    }
    .item-leaf:active { background: #e0e7ff; }
    .item-leaf.selected { 
      background: var(--secondary); color: white; 
      box-shadow: 0 4px 6px -2px rgba(37, 99, 235, 0.4); 
      font-weight: 500;
    }
    
    /* Highlight ƒë·∫∑c bi·ªát */
    .special-node > span { color: #db2777; font-weight: bold; }

    /* --- 6. EXAM CARD (Th·∫ª b√†i thi) --- */
    .exam-card { 
      background: var(--white); 
      padding: 25px; 
      border-radius: 16px; 
      box-shadow: var(--shadow); 
      width: 100%; 
      max-width: 600px; 
      display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .exam-title { 
      color: var(--primary); margin: 0 0 10px 0; font-size: 1.4rem; text-align: center; line-height: 1.4; 
    }
    .exam-subtitle { 
      color: var(--text-light); text-align: center; margin-bottom: 25px; font-size: 0.95rem; 
    }

    /* Code Buttons */
    .code-list { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
      gap: 12px; 
      margin-bottom: 25px; 
    }
    
    .code-wrapper { position: relative; }
    
    .code-btn { 
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: #f9fafb; border: 2px solid #e5e7eb; padding: 15px; 
      border-radius: 12px; text-decoration: none; color: var(--text); 
      cursor: pointer; transition: 0.2s; height: 100%;
    }
    .code-btn:active { transform: scale(0.97); border-color: var(--secondary); background: #eff6ff; }
    
    .code-btn b { color: var(--primary); font-size: 1.1rem; margin-top: 5px; }
    .code-btn span.icon { font-size: 1.5rem; }
    .code-btn.empty { border-style: dashed; color: #9ca3af; cursor: default; }

    /* N√∫t x√≥a (Admin) */
    .btn-delete {
      position: absolute; top: -8px; right: -8px; 
      background: #ef4444; color: white; border: none; width: 26px; height: 26px; 
      border-radius: 50%; font-weight: bold; cursor: pointer; 
      display: none; align-items: center; justify-content: center; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10;
    }
    .code-wrapper:hover .btn-delete.show { display: flex; }

    /* --- 7. ADMIN PANEL --- */
    .admin-panel { 
      margin-top: 20px; padding: 20px; border-radius: 12px; 
      background: #fffbeb; border: 1px solid #fcd34d; 
      display: none; 
    }
    .admin-panel.show { display: block; }
    
    .admin-header { font-weight: 700; color: #b45309; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
    
    .input-group { margin-bottom: 12px; }
    .input-group label { display: block; font-size: 0.8rem; color: #78350f; margin-bottom: 4px; font-weight: 600; }
    .input-row { display: flex; gap: 8px; }
    
    input[type="text"] { 
      flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; 
    }
    input[type="text"]:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2); }
    
    button.btn-action { 
      border: none; padding: 0 15px; border-radius: 8px; font-weight: 600; color: white; cursor: pointer;
    }
    .btn-save { background: #f59e0b; }
    .btn-add { background: #10b981; }
    .btn-create { background: #ef4444; width: 100%; padding: 12px; margin-top: 5px; }

    /* --- 8. RESPONSIVE MOBILE (QUAN TR·ªåNG) --- */
    @media (max-width: 768px) {
      header { height: 60px; padding: 10px; }
      .brand img { height: 40px; width: 40px; }
      .brand h1 { font-size: 1rem; }
      .btn-login { padding: 6px 10px; font-size: 0.8rem; }
      
      .main-container { flex-direction: column; }
      
      /* Tr√™n mobile: Menu ·ªü tr√™n, n·ªôi dung ·ªü d∆∞·ªõi */
      .sidebar { 
        width: 100%; 
        height: 40vh; /* Chi·∫øm 40% chi·ªÅu cao */
        border-right: none; 
        border-bottom: 1px solid var(--border);
      }
      
      .content-area {
        height: 60vh; /* Chi·∫øm 60% chi·ªÅu cao */
        padding: 15px;
      }
      
      .exam-card { padding: 20px; width: 100%; border-radius: 12px; box-shadow: none; border: 1px solid #e5e7eb; }
      .code-list { grid-template-columns: repeat(2, 1fr); }
      
      /* ·∫®n n√∫t x√≥a tr√™n mobile ƒë·ªÉ ƒë·ª° b·∫•m nh·∫ßm, mu·ªën x√≥a th√¨ login PC */
      .btn-delete.show { display: flex; width: 30px; height: 30px; }
    }

    /* --- 9. LOADING & PLACEHOLDER --- */
    #loading { 
      position: fixed; top:0; left:0; width:100%; height:100%; 
      background: rgba(255,255,255,0.95); z-index: 9999; 
      display: flex; flex-direction: column; justify-content: center; align-items: center; 
      color: var(--primary); font-weight: 600;
    }
    .spinner {
      width: 40px; height: 40px; border: 4px solid #bfdbfe; 
      border-top: 4px solid var(--secondary); border-radius: 50%; 
      animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .placeholder-msg { 
      margin-top: 50px; color: var(--text-light); text-align: center; 
      display: flex; flex-direction: column; align-items: center; 
    }
    .placeholder-msg div { font-size: 3rem; margin-bottom: 10px; opacity: 0.3; }
  </style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <div>ƒêang k·∫øt n·ªëi d·ªØ li·ªáu...</div>
</div>

<header>
  <div class="brand">
    <img src="https://raw.githubusercontent.com/LeHoangNgocDuc/LinkdethiAnPhuc/main/logo.jpg" alt="Logo An Ph√∫c">
    <h1>AN PH√öC EDUCATION <span>H·ªá th·ªëng ki·ªÉm tra tr·ª±c tuy·∫øn</span></h1>
  </div>
  <button class="btn-login" id="loginBtn" onclick="toggleLogin()">üîí GV</button>
</header>

<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('regular')">Th∆∞·ªùng xuy√™n</button>
  <button class="tab-btn" onclick="switchTab('periodic')">ƒê·ªãnh k·ª≥ & Cu·ªëi c·∫•p</button>
</div>

<div class="main-container">
  <div class="sidebar" id="sidebarContent"></div>
  
  <div class="content-area">
    
    <div id="placeholder" class="placeholder-msg">
      <div>üëà</div>
      <span>Vui l√≤ng ch·ªçn b√†i thi t·ª´ danh s√°ch</span>
    </div>
    
    <div id="examCard" class="exam-card">
      <h2 id="examTitle" class="exam-title">T√™n ƒê·ªÅ Thi</h2>
      <div class="exam-subtitle">Ch·ªçn m√£ ƒë·ªÅ ƒë·ªÉ COPY v√† l√†m b√†i:</div>
      
      <div id="codeList" class="code-list"></div>

      <div id="adminPanel" class="admin-panel">
        <div class="admin-header">üõ†Ô∏è C√îNG C·ª§ GI√ÅO VI√äN</div>
        
        <div class="input-group" id="editNameGroup">
           <label>S·ª≠a t√™n b√†i thi:</label>
           <div class="input-row">
             <input type="text" id="editNameInput">
             <button class="btn-action btn-save" onclick="saveName()">L∆∞u</button>
           </div>
        </div>

        <div class="input-group">
           <label>Th√™m m√£ ƒë·ªÅ (VD: 101, 102):</label>
           <div class="input-row">
             <input type="text" id="addCodeInput" placeholder="Nh·∫≠p m√£...">
             <button class="btn-action btn-add" onclick="addCode()">+ Th√™m</button>
           </div>
        </div>

        <div style="margin-top: 15px; border-top: 1px dashed #d97706; padding-top: 10px;">
           <label style="color:#b45309; margin-bottom:5px; display:block;">‚ûï T·∫†O ƒê·ªÄ M·ªöI (V√†o m·ª•c hi·ªán t·∫°i)</label>
           <input type="text" id="createExamName" placeholder="T√™n ƒë·ªÅ m·ªõi..." style="margin-bottom:5px; width:100%">
           <input type="text" id="createExamCode" placeholder="M√£ ƒë·ªÅ ƒë·∫ßu ti√™n..." style="width:100%">
           <button class="btn-action btn-create" onclick="createNewExam()">T·∫°o Ngay</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ======================================================
  // 1. C·∫§U H√åNH API (LINK TH·∫¶Y Y√äU C·∫¶U)
  // ======================================================
  const API_BASE = "https://script.google.com/macros/s/AKfycbzxq3D8DnKbsXRkiO2z76gG0zz6fZIqEvQEVqXjDRjCGWx-o630qndwjNNsTi6A6LNf/exec";
  
  // Bi·∫øn to√†n c·ª•c
  let regularData = [], periodicData = [], isAdmin = false, currentTab = 'regular', currentItem = null;

  // ======================================================
  // 2. H√ÄM K·∫æT N·ªêI API (S·ª¨ D·ª§NG FETCH ƒê·ªÇ TR√ÅNH L·ªñI VERCEL)
  // ======================================================
  async function callAPI(params) {
    const queryString = new URLSearchParams(params).toString();
    const url = API_BASE + "?" + queryString;
    
    try {
      // mode 'cors' gi√∫p fetch qua domain kh√°c
      const response = await fetch(url, { method: 'GET' });
      // Google Script tr·∫£ v·ªÅ JSON, ta parse n√≥
      const data = await response.json(); 
      return data;
    } catch (e) {
      console.error("L·ªói Fetch:", e);
      // Fallback cho tr∆∞·ªùng h·ª£p m·∫°ng lag ho·∫∑c redirect
      return null;
    }
  }

  // Kh·ªüi t·∫°o
  async function init() {
    try {
      const [regRes, perRes] = await Promise.all([
        callAPI({ action: "getRegular" }),
        callAPI({ action: "getPeriodic" })
      ]);
      
      if (regRes) regularData = regRes;
      if (perRes) periodicData = perRes;
      
      document.getElementById('loading').style.display = 'none';
      renderSidebar();
    } catch (e) {
      alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra ƒë∆∞·ªùng truy·ªÅn.");
      document.getElementById('loading').innerText = "L·ªói k·∫øt n·ªëi!";
    }
  }
  
  window.onload = init;

  // ======================================================
  // 3. LOGIC GIAO DI·ªÜN (SIDEBAR & TABS)
  // ======================================================
  function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    renderSidebar();
    document.getElementById('examCard').style.display = 'none';
    document.getElementById('placeholder').style.display = 'flex';
    currentItem = null;
  }

  function renderSidebar() {
    const root = document.getElementById('sidebarContent');
    root.innerHTML = "";
    if (currentTab === 'regular') renderTree(regularData, root);
    else renderList(periodicData, root);
  }

  function renderTree(data, root) {
    if(!data || data.length === 0) { root.innerHTML = "<div style='text-align:center; padding:20px; color:#999'>Ch∆∞a c√≥ d·ªØ li·ªáu</div>"; return; }
    
    const tree = {};
    data.forEach(item => {
      if (!tree[item.grade]) tree[item.grade] = {};
      if (!tree[item.grade][item.chapter]) tree[item.grade][item.chapter] = [];
      tree[item.grade][item.chapter].push(item);
    });

    const ul = document.createElement('ul');
    for (let grade in tree) {
      let li = document.createElement('li');
      li.innerHTML = `<div class="caret" onclick="toggleNested(this)">‚ñ∂ ${grade}</div>`;
      
      let chapUl = document.createElement('ul');
      chapUl.className = "nested";
      
      for (let chap in tree[grade]) {
        let chapLi = document.createElement('li');
        chapLi.innerHTML = `<div class="caret" onclick="toggleNested(this)">‚ñ∂ ${chap}</div>`;
        
        let lessonUl = document.createElement('ul');
        lessonUl.className = "nested";
        
        tree[grade][chap].forEach(lesson => {
           let lessonLi = document.createElement('li');
           lessonLi.className = "item-leaf";
           lessonLi.innerText = lesson.lesson;
           lessonLi.onclick = () => selectExam(lesson, 'regular');
           lessonUl.appendChild(lessonLi);
        });
        
        chapLi.appendChild(lessonUl);
        chapUl.appendChild(chapLi);
      }
      li.appendChild(chapUl);
      ul.appendChild(li);
    }
    root.appendChild(ul);
  }

  function renderList(data, root) {
    if(!data) return;
    const order = ["To√°n 6", "To√°n 7", "To√°n 8", "To√°n 9", "TS10", "To√°n 10", "To√°n 11", "To√°n 12", "TNTHPT"];
    const grouped = {};
    data.forEach(i => { if(!grouped[i.category]) grouped[i.category]=[]; grouped[i.category].push(i); });

    const ul = document.createElement('ul');
    order.forEach(cat => {
      if (grouped[cat]) {
        let li = document.createElement('li');
        if (cat === "TS10" || cat === "TNTHPT") li.className = "special-node";
        
        li.innerHTML = `<div class="caret" onclick="toggleNested(this)">‚ñ∂ ${cat}</div>`;
        
        let subUl = document.createElement('ul');
        subUl.className = "nested";
        
        grouped[cat].forEach(exam => {
           let subLi = document.createElement('li');
           subLi.className = "item-leaf";
           subLi.innerText = exam.displayName;
           subLi.onclick = () => selectExam(exam, 'periodic');
           subUl.appendChild(subLi);
        });
        
        li.appendChild(subUl);
        ul.appendChild(li);
      }
    });
    root.appendChild(ul);
  }

  function toggleNested(elm) {
    elm.parentElement.querySelector(".nested").classList.toggle("active");
    elm.classList.toggle("caret-down");
  }

  // ======================================================
  // 4. LOGIC CH·ªåN B√ÄI THI & COPY M√É
  // ======================================================
  function selectExam(item, type) {
    currentItem = item;
    currentItem.dataType = type;
    
    // Highlight
    document.querySelectorAll('.item-leaf').forEach(el => el.classList.remove('selected'));
    event.target.classList.add('selected');
    
    // Show Card
    document.getElementById('placeholder').style.display = 'none';
    document.getElementById('examCard').style.display = 'block';
    document.getElementById('examTitle').innerText = item.displayName || item.lesson;
    
    // Scroll to top on mobile
    if(window.innerWidth < 768) {
       document.querySelector('.content-area').scrollTop = 0;
    }

    renderCodes(item.code);
    updateAdminUI();
  }

  function renderCodes(codeStr) {
    const div = document.getElementById('codeList');
    div.innerHTML = "";
    
    if(!codeStr) {
        div.innerHTML = `<div class="code-btn empty" style="width:100%">Ch∆∞a c√≥ m√£ ƒë·ªÅ</div>`;
        return;
    }
    
    const codes = codeStr.toString().split(',').map(c=>c.trim()).filter(c=>c);
    
    codes.forEach(code => {
      let wrapper = document.createElement('div');
      wrapper.className = 'code-wrapper';

      let btn = document.createElement('div');
      btn.className = "code-btn";
      btn.innerHTML = `<span class="icon">üìù</span><b>${code}</b>`;
      
      // LOGIC COPY V√Ä M·ªû LINK
      btn.onclick = () => {
         navigator.clipboard.writeText(code).then(() => {
             if(confirm(`ƒê√£ copy m√£: ${code}\n\nNh·∫•n OK ƒë·ªÉ m·ªü trang l√†m b√†i.`)) {
                 window.open(API_BASE + "?code=" + encodeURIComponent(code), "_blank");
             }
         }).catch(() => {
             prompt("Copy th·ªß c√¥ng m√£ n√†y:", code);
             window.open(API_BASE + "?code=" + encodeURIComponent(code), "_blank");
         });
      };
      
      // N√∫t X√≥a (Admin)
      let delBtn = document.createElement('button');
      delBtn.className = "btn-delete " + (isAdmin ? 'show' : '');
      delBtn.innerText = "X";
      delBtn.onclick = (e) => { e.stopPropagation(); deleteCode(code); };

      wrapper.appendChild(btn);
      wrapper.appendChild(delBtn);
      div.appendChild(wrapper);
    });
  }

  // ======================================================
  // 5. CH·ª®C NƒÇNG ADMIN (GI√ÅO VI√äN)
  // ======================================================
  async function toggleLogin() {
    if (!isAdmin) {
      let p = prompt("M·∫≠t kh·∫©u Gi√°o Vi√™n:");
      if(!p) return;
      
      const res = await callAPI({ action: "login", pass: p });
      if (res && res.valid) {
        isAdmin = true;
        document.getElementById('loginBtn').innerText = "üîì ƒê√£ m·ªü";
        updateAdminUI();
        alert("ƒê√£ ƒëƒÉng nh·∫≠p th√†nh c√¥ng!");
      } else {
        alert("Sai m·∫≠t kh·∫©u!");
      }
    } else {
      isAdmin = false;
      document.getElementById('loginBtn').innerText = "üîí GV";
      updateAdminUI();
    }
  }

  function updateAdminUI() {
    const panel = document.getElementById('adminPanel');
    const deleteBtns = document.querySelectorAll('.btn-delete');
    
    if (isAdmin) {
      panel.classList.add('show');
      deleteBtns.forEach(b => b.classList.add('show'));
      
      // Hi·ªán √¥ s·ª≠a t√™n ch·ªâ cho ƒê·ªãnh k·ª≥
      if (currentItem && currentItem.dataType === 'periodic') {
        document.getElementById('editNameGroup').style.display = 'block';
        document.getElementById('editNameInput').value = currentItem.displayName || "";
      } else {
        document.getElementById('editNameGroup').style.display = 'none';
      }
    } else {
      panel.classList.remove('show');
      deleteBtns.forEach(b => b.classList.remove('show'));
    }
  }

  // --- Th√™m M√£ ---
  async function addCode() {
    let code = document.getElementById('addCodeInput').value.trim();
    if(!code) return;
    
    let newCodes = currentItem.code ? currentItem.code + "," + code : code;
    const sheetName = currentItem.dataType === 'periodic' ? 'PeriodicData' : 'RegularData';
    
    await callAPI({ action: "updateCode", sheet: sheetName, row: currentItem.row, code: newCodes });
    
    currentItem.code = newCodes;
    renderCodes(newCodes);
    document.getElementById('addCodeInput').value = "";
    alert("ƒê√£ th√™m m√£ ƒë·ªÅ!");
  }

  // --- X√≥a M√£ ---
  async function deleteCode(codeDel) {
    if(!confirm(`X√≥a m√£ ƒë·ªÅ "${codeDel}"?`)) return;
    
    let codes = currentItem.code.toString().split(',').map(c=>c.trim());
    let newCodes = codes.filter(c => c !== codeDel).join(",");
    const sheetName = currentItem.dataType === 'periodic' ? 'PeriodicData' : 'RegularData';
    
    await callAPI({ action: "updateCode", sheet: sheetName, row: currentItem.row, code: newCodes });
    
    currentItem.code = newCodes;
    renderCodes(newCodes);
  }

  // --- S·ª≠a T√™n ---
  async function saveName() {
    let name = document.getElementById('editNameInput').value.trim();
    if(!name) return;
    
    await callAPI({ action: "updateName", row: currentItem.row, newName: name });
    
    currentItem.displayName = name;
    document.getElementById('examTitle').innerText = name;
    renderSidebar(); // Refresh menu
    alert("ƒê√£ c·∫≠p nh·∫≠t t√™n!");
  }

  // --- T·∫°o ƒê·ªÅ M·ªõi ---
  async function createNewExam() {
    if(!currentItem) { alert("H√£y ch·ªçn m·ªôt m·ª•c (L·ªõp) b√™n tr√°i tr∆∞·ªõc!"); return; }
    
    let name = document.getElementById('createExamName').value.trim();
    let code = document.getElementById('createExamCode').value.trim();
    if(!name) { alert("C·∫ßn nh·∫≠p t√™n ƒë·ªÅ!"); return; }
    
    let sheetName = currentTab === 'periodic' ? 'PeriodicData' : 'RegularData';
    let cat = currentItem.category || currentItem.grade;
    let type = currentItem.examType || currentItem.chapter;
    
    if(confirm(`Th√™m ƒë·ªÅ m·ªõi v√†o m·ª•c "${cat}"?`)) {
       await callAPI({ action: "addExam", sheet: sheetName, cat: cat, type: type, name: name, code: code });
       alert("ƒê√£ t·∫°o ƒë·ªÅ m·ªõi! ƒêang t·∫£i l·∫°i...");
       
       // Clear input & Reload
       document.getElementById('createExamName').value = "";
       document.getElementById('createExamCode').value = "";
       init();
    }
  }
</script>

</body>
</html>
