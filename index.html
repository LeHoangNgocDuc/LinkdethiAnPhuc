<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KI·ªÇM TRA TR·ª∞C TUY·∫æN AN PH√öC EDUCATION</title>
  <style>
    /* ... (Gi·ªØ nguy√™n to√†n b·ªô CSS c≈© c·ªßa th·∫ßy) ... */
    :root { 
      --primary: #1e3a8a; --secondary: #2563eb; --accent: #f59e0b; 
      --bg: #f8fafc; --text: #334155; --white: #ffffff;
    }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
    
    header { background: var(--primary); color: var(--white); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    h1 { margin: 0; font-size: 1.2rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
    .btn-login { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 15px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
    .btn-login:hover { background: rgba(255,255,255,0.3); }

    .tabs { display: flex; background: var(--white); border-bottom: 2px solid #e2e8f0; }
    .tab-btn { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; transition: 0.3s; }
    .tab-btn:hover { background: #eff6ff; color: var(--secondary); }
    .tab-btn.active { color: var(--secondary); border-bottom-color: var(--secondary); background: #eff6ff; }
    
    .main-container { flex: 1; display: flex; overflow: hidden; }
    .sidebar { width: 340px; background: var(--white); border-right: 1px solid #e2e8f0; overflow-y: auto; padding: 15px 10px; display: flex; flex-direction: column; }
    .content-area { flex: 1; padding: 40px; text-align: center; background: #f1f5f9; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }

    ul { list-style: none; padding-left: 20px; margin: 0; }
    li { margin: 2px 0; }
    .caret { cursor: pointer; user-select: none; display: flex; align-items: center; padding: 8px 10px; border-radius: 6px; font-weight: 600; color: #475569; transition: 0.2s; }
    .caret:hover { background: #f1f5f9; color: var(--primary); }
    .caret::before { content: "‚ñ∂"; margin-right: 8px; font-size: 0.75rem; color: #94a3b8; transition: 0.2s; }
    .caret-down::before { transform: rotate(90deg); color: var(--secondary); }
    .nested { display: none; margin-left: 8px; border-left: 2px solid #e2e8f0; }
    .active { display: block; }
    .item-leaf { cursor: pointer; padding: 8px 12px; display: block; color: #475569; border-radius: 6px; font-size: 0.95rem; margin: 2px 0; transition: 0.2s; }
    .item-leaf:hover { background: #dbeafe; color: var(--primary); font-weight: 500; }
    .item-leaf.selected { background: var(--secondary); color: white; font-weight: 600; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }
    .special-node > span { color: #db2777; font-weight: 700; }

    .exam-card { background: var(--white); padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); width: 100%; max-width: 700px; display: none; }
    .exam-title { color: var(--primary); margin: 0 0 10px 0; font-size: 1.8rem; }
    .exam-subtitle { color: #64748b; margin-bottom: 30px; }
    
    .code-list { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-bottom: 30px; }
    .code-wrapper { position: relative; }
    .code-btn { 
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: #f8fafc; border: 2px solid #e2e8f0; padding: 15px 25px; 
      border-radius: 10px; text-decoration: none; color: var(--text); cursor: pointer; transition: 0.2s;
      min-width: 120px; user-select: none;
    }
    .code-btn span.icon { font-size: 1.5rem; margin-bottom: 5px; }
    .code-btn b { font-size: 1.1rem; color: var(--primary); }
    .code-btn:hover { border-color: var(--secondary); background: #eff6ff; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(37, 99, 235, 0.15); }
    .code-btn.empty { border-style: dashed; color: #94a3b8; cursor: default; transform: none; box-shadow: none; }
    
    .btn-delete-code {
        position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border: none;
        width: 24px; height: 24px; border-radius: 50%; font-weight: bold; cursor: pointer;
        display: none; align-items: center; justify-content: center; font-size: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .code-wrapper:hover .btn-delete-code.show { display: flex; }

    .admin-panel { margin-top: 30px; padding: 25px; border-top: 2px dashed #e2e8f0; display: none; text-align: left; background: #fffbeb; border-radius: 10px; border: 1px solid #fcd34d; }
    .admin-panel.show { display: block; animation: fadeIn 0.3s; }
    .admin-header { font-size: 1rem; font-weight: 700; color: #b45309; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    
    .input-row { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
    .input-row label { min-width: 100px; font-weight: 600; color: #78350f; }
    input[type="text"] { flex: 1; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem; transition: 0.2s; }
    input[type="text"]:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2); }
    
    button.btn-admin { border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; transition: 0.2s; white-space: nowrap; }
    .btn-save { background: #f59e0b; } .btn-save:hover { background: #d97706; }
    .btn-add { background: #10b981; } .btn-add:hover { background: #059669; }
    .btn-create { background: #ef4444; } .btn-create:hover { background: #dc2626; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .placeholder-state { margin-top: 100px; color: #94a3b8; font-size: 1.1rem; display: flex; flex-direction: column; align-items: center; }
    .placeholder-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }
    
    #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; justify-content:center; align-items:center; font-size:1.2rem; color:var(--primary); z-index:1000; }
  </style>
</head>
<body>

<div id="loading">ƒêang k·∫øt n·ªëi d·ªØ li·ªáu...</div>

<header>
  <h1>KI·ªÇM TRA TR·ª∞C TUY·∫æN AN PH√öC EDUCATION</h1>
  <button class="btn-login" id="loginBtn" onclick="toggleLogin()">üîí GV ƒêƒÉng nh·∫≠p</button>
</header>

<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('regular')">Ki·ªÉm tra Th∆∞·ªùng xuy√™n</button>
  <button class="tab-btn" onclick="switchTab('periodic')">Ki·ªÉm tra ƒê·ªãnh k·ª≥ & Cu·ªëi c·∫•p</button>
</div>

<div class="main-container">
  <div class="sidebar" id="sidebarContent"></div>
  
  <div class="content-area">
    <div id="placeholder" class="placeholder-state">
      <div class="placeholder-icon">üëà</div>
      <div>Vui l√≤ng ch·ªçn b√†i thi t·ª´ danh s√°ch b√™n tr√°i</div>
    </div>
    
    <div id="examCard" class="exam-card">
      <h2 id="examTitle" class="exam-title">T√™n ƒê·ªÅ Thi</h2>
      <div class="exam-subtitle">Click v√†o m√£ ƒë·ªÅ ƒë·ªÉ <b>COPY</b>, sau ƒë√≥ link b√†i thi s·∫Ω m·ªü ra:</div>
      
      <div id="codeList" class="code-list"></div>

      <div id="adminPanel" class="admin-panel">
        <div class="admin-header">üõ†Ô∏è KHU V·ª∞C GI√ÅO VI√äN</div>
        <div class="input-row" id="editNameRow">
           <label>T√™n b√†i thi:</label>
           <input type="text" id="editNameInput">
           <button class="btn-admin btn-save" onclick="saveName()">L∆∞u T√™n</button>
        </div>
        <div class="input-row">
           <label>Th√™m m√£ ƒë·ªÅ:</label>
           <input type="text" id="addCodeInput" placeholder="VD: DE-02, MA-LE...">
           <button class="btn-admin btn-add" onclick="addCode()">+ Th√™m M√£</button>
        </div>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #fcd34d;">
        <div style="font-weight:bold; color:#b45309; margin-bottom:10px;">‚ûï T·∫†O ƒê·ªÄ THI M·ªöI (V√†o m·ª•c ƒëang ch·ªçn)</div>
        <div class="input-row">
           <input type="text" id="createExamName" placeholder="T√™n ƒë·ªÅ m·ªõi (VD: ƒê·ªÅ thi th·ª≠ s·ªë 5)">
        </div>
        <div class="input-row">
           <input type="text" id="createExamCode" placeholder="M√£ ƒë·ªÅ (VD: THU-05)">
           <button class="btn-admin btn-create" onclick="createNewExam()">T·∫°o Ngay</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ==========================================
  // TH·∫¶Y D√ÅN LINK WEB APP C·ª¶A TH·∫¶Y V√ÄO ƒê√ÇY (PH·∫¢I L√Ä LINK /exec)
  // ==========================================
  const API_BASE = "https://script.google.com/macros/s/AKfycbzxq3D8DnKbsXRkiO2z76gG0zz6fZIqEvQEVqXjDRjCGWx-o630qndwjNNsTi6A6LNf/exec";
  const REDIRECT_BASE = API_BASE; 

  let regularData = [], periodicData = [], isAdmin = false, currentTab = 'regular', currentItem = null;

  // --- H√ÄM G·ªåI API ƒê∆Ø·ª¢C S·ª¨A L·∫†I ƒê·ªÇ TR√ÅNH L·ªñI CORS ---
  async function callAPI(params) {
    const queryString = new URLSearchParams(params).toString();
    const url = API_BASE + "?" + queryString;
    
    try {
        // S·ª≠ d·ª•ng fetch th√¥ng th∆∞·ªùng nh∆∞ng Google Script s·∫Ω redirect
        // Ch√∫ng ta c·∫ßn x·ª≠ l√Ω k·∫øt qu·∫£ JSON tr·∫£ v·ªÅ
        const response = await fetch(url);
        
        // Google Script th∆∞·ªùng tr·∫£ v·ªÅ text/plain ho·∫∑c redirect, ta c·∫ßn parse c·∫©n th·∫≠n
        const text = await response.text();
        try {
            return JSON.parse(text);
        } catch (e) {
            console.warn("API tr·∫£ v·ªÅ kh√¥ng ph·∫£i JSON:", text);
            return { error: "Invalid JSON response" };
        }
    } catch (e) {
        console.error("Fetch Error:", e);
        // Fallback: N·∫øu fetch b·ªã ch·∫∑n ho√†n to√†n (hi·∫øm khi x·∫£y ra n·∫øu config ƒë√∫ng)
        alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi Server. Th·∫ßy h√£y ki·ªÉm tra l·∫°i: \n1. Link API ƒë√∫ng ch∆∞a? \n2. ƒê√£ deploy ch·∫ø ƒë·ªô 'Anyone' ch∆∞a?");
        return null;
    }
  }

  // --- C√ÅC H√ÄM C√íN L·∫†I GI·ªÆ NGUY√äN ---
  // (Em d√°n l·∫°i to√†n b·ªô ƒë·ªÉ th·∫ßy copy 1 l·∫ßn l√† ch·∫°y)

  async function init() {
    // G·ªçi API tu·∫ßn t·ª± ƒë·ªÉ tr√°nh ngh·∫Ωn m·∫°ng Google
    const regRes = await callAPI({ action: "getRegular" });
    if(regRes) regularData = regRes;
    
    const perRes = await callAPI({ action: "getPeriodic" });
    if(perRes) periodicData = perRes;

    document.getElementById('loading').style.display = 'none';
    renderSidebar();
  }
  
  window.onload = init;

  function renderSidebar() {
    const root = document.getElementById('sidebarContent');
    root.innerHTML = "";
    if(currentTab === 'regular') renderTree(regularData, root);
    else renderList(periodicData, root);
  }

  // Render C√¢y th∆∞ m·ª•c (Th∆∞·ªùng xuy√™n)
  function renderTree(data, root) {
    const tree = {};
    if(!data) return;
    data.forEach(item => {
      if (!tree[item.grade]) tree[item.grade] = {};
      if (!tree[item.grade][item.chapter]) tree[item.grade][item.chapter] = [];
      tree[item.grade][item.chapter].push(item);
    });

    const ul = document.createElement('ul');
    for (let grade in tree) {
      let li = document.createElement('li');
      li.innerHTML = `<span class="caret" onclick="toggleNested(this)">‚ñ∂ ${grade}</span>`;
      let chapUl = document.createElement('ul');
      chapUl.className = "nested";
      for (let chap in tree[grade]) {
        let chapLi = document.createElement('li');
        chapLi.innerHTML = `<span class="caret" onclick="toggleNested(this)">‚ñ∂ ${chap}</span>`;
        let lessonUl = document.createElement('ul');
        lessonUl.className = "nested";
        tree[grade][chap].forEach(lesson => {
           let lessonLi = document.createElement('li');
           lessonLi.className = "item-leaf";
           lessonLi.innerText = lesson.lesson;
           lessonLi.onclick = () => selectExam(lesson, 'regular');
           lessonUl.appendChild(lessonLi);
        });
        chapLi.appendChild(lessonUl);
        chapUl.appendChild(chapLi);
      }
      li.appendChild(chapUl);
      ul.appendChild(li);
    }
    root.appendChild(ul);
  }

  // Render Danh s√°ch (ƒê·ªãnh k·ª≥)
  function renderList(data, root) {
    if(!data) return;
    const order = ["To√°n 6", "To√°n 7", "To√°n 8", "To√°n 9", "TS10", "To√°n 10", "To√°n 11", "To√°n 12", "TNTHPT"];
    const grouped = {};
    data.forEach(i => { if(!grouped[i.category]) grouped[i.category]=[]; grouped[i.category].push(i); });

    const ul = document.createElement('ul');
    order.forEach(cat => {
      if(grouped[cat]) {
        let li = document.createElement('li');
        li.innerHTML = `<span class="caret" onclick="toggleNested(this)">‚ñ∂ ${cat}</span>`;
        let subUl = document.createElement('ul');
        subUl.className = "nested";
        grouped[cat].forEach(exam => {
           let subLi = document.createElement('li');
           subLi.className = "item-leaf";
           subLi.innerText = exam.displayName;
           subLi.onclick = () => selectExam(exam, 'periodic');
           subUl.appendChild(subLi);
        });
        li.appendChild(subUl);
        ul.appendChild(li);
      }
    });
    root.appendChild(ul);
  }

  function toggleNested(elm) {
    elm.parentElement.querySelector(".nested").classList.toggle("active");
  }

  function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    renderSidebar();
    document.getElementById('examCard').classList.add('hidden');
    document.getElementById('placeholder').style.display = 'block';
  }

  function selectExam(item, type) {
    currentItem = item;
    currentItem.dataType = type;
    document.getElementById('placeholder').style.display = 'none';
    document.getElementById('examCard').classList.remove('hidden');
    document.getElementById('examTitle').innerText = item.displayName || item.lesson;
    renderCodes(item.code);
    updateAdminUI();
  }

  function renderCodes(codeStr) {
    const div = document.getElementById('codeList');
    div.innerHTML = "";
    if(!codeStr) {
        div.innerHTML = "Ch∆∞a c√≥ m√£ ƒë·ªÅ";
        return;
    }
    const codes = codeStr.toString().split(',').map(c=>c.trim()).filter(c=>c);
    
    codes.forEach(code => {
      let btn = document.createElement('div');
      btn.className = "code-btn";
      // Hi·ªÉn th·ªã n√∫t x√≥a n·∫øu l√† admin
      let deleteIcon = isAdmin ? `<span onclick="deleteCode('${code}', event)" style="color:red;font-weight:bold;margin-left:10px;font-size:1.2em;">&times;</span>` : "";
      
      btn.innerHTML = `üìù <b>${code}</b> ${deleteIcon}`;
      btn.onclick = () => {
         navigator.clipboard.writeText(code);
         if(confirm(`ƒê√£ copy m√£: ${code}. M·ªü link thi?`)) window.open(REDIRECT_BASE + "?code=" + encodeURIComponent(code), "_blank");
      };
      div.appendChild(btn);
    });
  }

  // --- ADMIN FUNCTIONS ---
  async function toggleLogin() {
    let p = prompt("M·∫≠t kh·∫©u Admin:");
    if(!p) return;
    
    // Check pass qua API
    let res = await callAPI({ action: "login", pass: p });
    
    if(res && res.valid) { 
        isAdmin = true; 
        updateAdminUI(); 
        alert("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!"); 
    } else { 
        alert("Sai m·∫≠t kh·∫©u!"); 
    }
  }

  function updateAdminUI() {
    const panel = document.getElementById('adminPanel');
    const btn = document.getElementById('loginBtn');
    if(isAdmin) {
      panel.classList.add('show');
      btn.innerText = "üîì ƒê√£ m·ªü";
      // Re-render ƒë·ªÉ hi·ªán n√∫t x√≥a
      if(currentItem) renderCodes(currentItem.code); 
    } else {
      panel.classList.remove('show');
    }
  }

  async function saveName() {
    let name = document.getElementById('editNameInput').value;
    if(!name) return;
    await callAPI({ action: "updateName", row: currentItem.row, newName: name });
    currentItem.displayName = name;
    document.getElementById('examTitle').innerText = name;
    renderSidebar(); // Update sidebar
    alert("ƒê√£ s·ª≠a t√™n!");
  }

  async function addCode() {
    let code = document.getElementById('addCodeInput').value;
    if(!code) return;
    let newCodes = currentItem.code ? currentItem.code + "," + code : code;
    
    const sheetName = currentItem.dataType==='periodic'?'PeriodicData':'RegularData';
    
    await callAPI({ action: "updateCode", sheet: sheetName, row: currentItem.row, code: newCodes });
    
    currentItem.code = newCodes;
    renderCodes(newCodes);
    document.getElementById('addCodeInput').value = "";
    alert("ƒê√£ th√™m m√£!");
  }

  async function deleteCode(codeDel, e) {
    if(e) e.stopPropagation();
    if(!confirm(`X√≥a m√£ "${codeDel}"?`)) return;
    
    let codes = currentItem.code.toString().split(',').map(c=>c.trim());
    let newCodes = codes.filter(c=>c!=codeDel).join(",");
    
    const sheetName = currentItem.dataType==='periodic'?'PeriodicData':'RegularData';
    
    await callAPI({ action: "updateCode", sheet: sheetName, row: currentItem.row, code: newCodes });
    
    currentItem.code = newCodes;
    renderCodes(newCodes);
    alert("ƒê√£ x√≥a!");
  }

  async function createNewExam() {
    let name = document.getElementById('newExamName').value;
    let code = document.getElementById('newExamCode').value;
    if(!name) { alert("C·∫ßn nh·∫≠p t√™n ƒë·ªÅ!"); return; }
    
    // L·∫•y th√¥ng tin nh√≥m hi·ªán t·∫°i
    let cat = currentItem.category || currentItem.grade;
    let type = currentItem.examType || currentItem.chapter;
    
    const sheetName = currentTab==='periodic'?'PeriodicData':'RegularData';
    
    await callAPI({ action: "addExam", sheet: sheetName, cat: cat, type: type, name: name, code: code });
    
    alert("ƒê√£ t·∫°o ƒë·ªÅ m·ªõi! ƒêang t·∫£i l·∫°i d·ªØ li·ªáu...");
    
    // Clear input
    document.getElementById('newExamName').value = "";
    document.getElementById('newExamCode').value = "";
    
    // Reload data
    init(); 
  }
</script>

</body>
</html>
