<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KI·ªÇM TRA TR·ª∞C TUY·∫æN AN PH√öC EDUCATION</title>
  <style>
    /* ... (Gi·ªØ nguy√™n to√†n b·ªô CSS c·ªßa th·∫ßy) ... */
    :root { --primary: #1e3a8a; --bg: #f8fafc; --text: #334155; }
    body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
    header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; }
    .main-container { flex: 1; display: flex; overflow: hidden; }
    .sidebar { width: 300px; background: white; overflow-y: auto; padding: 10px; border-right: 1px solid #ccc; }
    .content-area { flex: 1; padding: 20px; overflow-y: auto; }
    .hidden { display: none; }
    .tabs { display: flex; background: white; border-bottom: 1px solid #ccc; }
    .tab-btn { flex: 1; padding: 15px; cursor: pointer; border: none; background: none; font-weight: bold; }
    .tab-btn.active { color: blue; border-bottom: 2px solid blue; }
    .caret { cursor: pointer; display: block; padding: 5px; }
    .nested { display: none; margin-left: 15px; }
    .active { display: block; }
    .item-leaf { cursor: pointer; padding: 5px; color: #555; }
    .item-leaf:hover { color: blue; }
    .code-btn { display: inline-block; padding: 10px; margin: 5px; border: 1px solid #ccc; cursor: pointer; background: white; }
    .code-btn:hover { background: #eee; }
    .admin-panel { margin-top: 20px; padding: 20px; background: #fff3cd; display: none; }
    .admin-panel.show { display: block; }
    #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; justify-content:center; align-items:center; font-size:1.2rem; color:var(--primary); z-index:1000; }
  </style>
</head>
<body>

<div id="loading">ƒêang k·∫øt n·ªëi d·ªØ li·ªáu...</div>

<header>
  <h3>AN PH√öC EDUCATION</h3>
  <button onclick="toggleLogin()" id="loginBtn">üîí GV ƒêƒÉng nh·∫≠p</button>
</header>

<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('regular')">Th∆∞·ªùng xuy√™n</button>
  <button class="tab-btn" onclick="switchTab('periodic')">ƒê·ªãnh k·ª≥ & Cu·ªëi c·∫•p</button>
</div>

<div class="main-container">
  <div class="sidebar" id="sidebarContent"></div>
  <div class="content-area">
    <div id="placeholder">üëà Ch·ªçn ƒë·ªÅ thi b√™n tr√°i</div>
    
    <div id="examCard" class="hidden">
      <h2 id="examTitle"></h2>
      <div id="codeList"></div>

      <div id="adminPanel" class="admin-panel">
        <h4>Khu v·ª±c Gi√°o vi√™n</h4>
        <input type="text" id="editNameInput" placeholder="S·ª≠a t√™n ƒë·ªÅ">
        <button onclick="saveName()">L∆∞u T√™n</button>
        <br><br>
        <input type="text" id="addCodeInput" placeholder="Th√™m m√£ (VD: 102)">
        <button onclick="addCode()">+ Th√™m M√£</button>
        <hr>
        <input type="text" id="newExamName" placeholder="T√™n ƒë·ªÅ m·ªõi">
        <input type="text" id="newExamCode" placeholder="M√£ ƒë·ªÅ m·ªõi">
        <button onclick="createNewExam()">T·∫°o ƒê·ªÅ M·ªõi</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ==========================================
  // TH·∫¶Y D√ÅN LINK WEB APP C·ª¶A TH·∫¶Y V√ÄO ƒê√ÇY (PH·∫¢I L√Ä LINK /exec)
  // ==========================================
  const API_BASE = "https://script.google.com/macros/s/AKfycbzxq3D8DnKbsXRkiO2z76gG0zz6fZIqEvQEVqXjDRjCGWx-o630qndwjNNsTi6A6LNf/exec";
  const REDIRECT_BASE = API_BASE; 

  let regularData = [], periodicData = [], isAdmin = false, currentTab = 'regular', currentItem = null;

  // --- H√ÄM G·ªåI API ƒê∆Ø·ª¢C S·ª¨A L·∫†I ƒê·ªÇ TR√ÅNH L·ªñI CORS ---
  async function callAPI(params) {
    const queryString = new URLSearchParams(params).toString();
    const url = API_BASE + "?" + queryString;
    
    try {
        // S·ª≠ d·ª•ng fetch th√¥ng th∆∞·ªùng nh∆∞ng Google Script s·∫Ω redirect
        // Ch√∫ng ta c·∫ßn x·ª≠ l√Ω k·∫øt qu·∫£ JSON tr·∫£ v·ªÅ
        const response = await fetch(url);
        
        // Google Script th∆∞·ªùng tr·∫£ v·ªÅ text/plain ho·∫∑c redirect, ta c·∫ßn parse c·∫©n th·∫≠n
        const text = await response.text();
        try {
            return JSON.parse(text);
        } catch (e) {
            console.warn("API tr·∫£ v·ªÅ kh√¥ng ph·∫£i JSON:", text);
            return { error: "Invalid JSON response" };
        }
    } catch (e) {
        console.error("Fetch Error:", e);
        // Fallback: N·∫øu fetch b·ªã ch·∫∑n ho√†n to√†n (hi·∫øm khi x·∫£y ra n·∫øu config ƒë√∫ng)
        alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi Server. Th·∫ßy h√£y ki·ªÉm tra l·∫°i: \n1. Link API ƒë√∫ng ch∆∞a? \n2. ƒê√£ deploy ch·∫ø ƒë·ªô 'Anyone' ch∆∞a?");
        return null;
    }
  }

  // --- C√ÅC H√ÄM C√íN L·∫†I GI·ªÆ NGUY√äN ---
  // (Em d√°n l·∫°i to√†n b·ªô ƒë·ªÉ th·∫ßy copy 1 l·∫ßn l√† ch·∫°y)

  async function init() {
    // G·ªçi API tu·∫ßn t·ª± ƒë·ªÉ tr√°nh ngh·∫Ωn m·∫°ng Google
    const regRes = await callAPI({ action: "getRegular" });
    if(regRes) regularData = regRes;
    
    const perRes = await callAPI({ action: "getPeriodic" });
    if(perRes) periodicData = perRes;

    document.getElementById('loading').style.display = 'none';
    renderSidebar();
  }
  
  window.onload = init;

  function renderSidebar() {
    const root = document.getElementById('sidebarContent');
    root.innerHTML = "";
    if(currentTab === 'regular') renderTree(regularData, root);
    else renderList(periodicData, root);
  }

  // Render C√¢y th∆∞ m·ª•c (Th∆∞·ªùng xuy√™n)
  function renderTree(data, root) {
    const tree = {};
    if(!data) return;
    data.forEach(item => {
      if (!tree[item.grade]) tree[item.grade] = {};
      if (!tree[item.grade][item.chapter]) tree[item.grade][item.chapter] = [];
      tree[item.grade][item.chapter].push(item);
    });

    const ul = document.createElement('ul');
    for (let grade in tree) {
      let li = document.createElement('li');
      li.innerHTML = `<span class="caret" onclick="toggleNested(this)">‚ñ∂ ${grade}</span>`;
      let chapUl = document.createElement('ul');
      chapUl.className = "nested";
      for (let chap in tree[grade]) {
        let chapLi = document.createElement('li');
        chapLi.innerHTML = `<span class="caret" onclick="toggleNested(this)">‚ñ∂ ${chap}</span>`;
        let lessonUl = document.createElement('ul');
        lessonUl.className = "nested";
        tree[grade][chap].forEach(lesson => {
           let lessonLi = document.createElement('li');
           lessonLi.className = "item-leaf";
           lessonLi.innerText = lesson.lesson;
           lessonLi.onclick = () => selectExam(lesson, 'regular');
           lessonUl.appendChild(lessonLi);
        });
        chapLi.appendChild(lessonUl);
        chapUl.appendChild(chapLi);
      }
      li.appendChild(chapUl);
      ul.appendChild(li);
    }
    root.appendChild(ul);
  }

  // Render Danh s√°ch (ƒê·ªãnh k·ª≥)
  function renderList(data, root) {
    if(!data) return;
    const order = ["To√°n 6", "To√°n 7", "To√°n 8", "To√°n 9", "TS10", "To√°n 10", "To√°n 11", "To√°n 12", "TNTHPT"];
    const grouped = {};
    data.forEach(i => { if(!grouped[i.category]) grouped[i.category]=[]; grouped[i.category].push(i); });

    const ul = document.createElement('ul');
    order.forEach(cat => {
      if(grouped[cat]) {
        let li = document.createElement('li');
        li.innerHTML = `<span class="caret" onclick="toggleNested(this)">‚ñ∂ ${cat}</span>`;
        let subUl = document.createElement('ul');
        subUl.className = "nested";
        grouped[cat].forEach(exam => {
           let subLi = document.createElement('li');
           subLi.className = "item-leaf";
           subLi.innerText = exam.displayName;
           subLi.onclick = () => selectExam(exam, 'periodic');
           subUl.appendChild(subLi);
        });
        li.appendChild(subUl);
        ul.appendChild(li);
      }
    });
    root.appendChild(ul);
  }

  function toggleNested(elm) {
    elm.parentElement.querySelector(".nested").classList.toggle("active");
  }

  function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    renderSidebar();
    document.getElementById('examCard').classList.add('hidden');
    document.getElementById('placeholder').style.display = 'block';
  }

  function selectExam(item, type) {
    currentItem = item;
    currentItem.dataType = type;
    document.getElementById('placeholder').style.display = 'none';
    document.getElementById('examCard').classList.remove('hidden');
    document.getElementById('examTitle').innerText = item.displayName || item.lesson;
    renderCodes(item.code);
    updateAdminUI();
  }

  function renderCodes(codeStr) {
    const div = document.getElementById('codeList');
    div.innerHTML = "";
    if(!codeStr) {
        div.innerHTML = "Ch∆∞a c√≥ m√£ ƒë·ªÅ";
        return;
    }
    const codes = codeStr.toString().split(',').map(c=>c.trim()).filter(c=>c);
    
    codes.forEach(code => {
      let btn = document.createElement('div');
      btn.className = "code-btn";
      // Hi·ªÉn th·ªã n√∫t x√≥a n·∫øu l√† admin
      let deleteIcon = isAdmin ? `<span onclick="deleteCode('${code}', event)" style="color:red;font-weight:bold;margin-left:10px;font-size:1.2em;">&times;</span>` : "";
      
      btn.innerHTML = `üìù <b>${code}</b> ${deleteIcon}`;
      btn.onclick = () => {
         navigator.clipboard.writeText(code);
         if(confirm(`ƒê√£ copy m√£: ${code}. M·ªü link thi?`)) window.open(REDIRECT_BASE + "?code=" + encodeURIComponent(code), "_blank");
      };
      div.appendChild(btn);
    });
  }

  // --- ADMIN FUNCTIONS ---
  async function toggleLogin() {
    let p = prompt("M·∫≠t kh·∫©u Admin:");
    if(!p) return;
    
    // Check pass qua API
    let res = await callAPI({ action: "login", pass: p });
    
    if(res && res.valid) { 
        isAdmin = true; 
        updateAdminUI(); 
        alert("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!"); 
    } else { 
        alert("Sai m·∫≠t kh·∫©u!"); 
    }
  }

  function updateAdminUI() {
    const panel = document.getElementById('adminPanel');
    const btn = document.getElementById('loginBtn');
    if(isAdmin) {
      panel.classList.add('show');
      btn.innerText = "üîì ƒê√£ m·ªü";
      // Re-render ƒë·ªÉ hi·ªán n√∫t x√≥a
      if(currentItem) renderCodes(currentItem.code); 
    } else {
      panel.classList.remove('show');
    }
  }

  async function saveName() {
    let name = document.getElementById('editNameInput').value;
    if(!name) return;
    await callAPI({ action: "updateName", row: currentItem.row, newName: name });
    currentItem.displayName = name;
    document.getElementById('examTitle').innerText = name;
    renderSidebar(); // Update sidebar
    alert("ƒê√£ s·ª≠a t√™n!");
  }

  async function addCode() {
    let code = document.getElementById('addCodeInput').value;
    if(!code) return;
    let newCodes = currentItem.code ? currentItem.code + "," + code : code;
    
    const sheetName = currentItem.dataType==='periodic'?'PeriodicData':'RegularData';
    
    await callAPI({ action: "updateCode", sheet: sheetName, row: currentItem.row, code: newCodes });
    
    currentItem.code = newCodes;
    renderCodes(newCodes);
    document.getElementById('addCodeInput').value = "";
    alert("ƒê√£ th√™m m√£!");
  }

  async function deleteCode(codeDel, e) {
    if(e) e.stopPropagation();
    if(!confirm(`X√≥a m√£ "${codeDel}"?`)) return;
    
    let codes = currentItem.code.toString().split(',').map(c=>c.trim());
    let newCodes = codes.filter(c=>c!=codeDel).join(",");
    
    const sheetName = currentItem.dataType==='periodic'?'PeriodicData':'RegularData';
    
    await callAPI({ action: "updateCode", sheet: sheetName, row: currentItem.row, code: newCodes });
    
    currentItem.code = newCodes;
    renderCodes(newCodes);
    alert("ƒê√£ x√≥a!");
  }

  async function createNewExam() {
    let name = document.getElementById('newExamName').value;
    let code = document.getElementById('newExamCode').value;
    if(!name) { alert("C·∫ßn nh·∫≠p t√™n ƒë·ªÅ!"); return; }
    
    // L·∫•y th√¥ng tin nh√≥m hi·ªán t·∫°i
    let cat = currentItem.category || currentItem.grade;
    let type = currentItem.examType || currentItem.chapter;
    
    const sheetName = currentTab==='periodic'?'PeriodicData':'RegularData';
    
    await callAPI({ action: "addExam", sheet: sheetName, cat: cat, type: type, name: name, code: code });
    
    alert("ƒê√£ t·∫°o ƒë·ªÅ m·ªõi! ƒêang t·∫£i l·∫°i d·ªØ li·ªáu...");
    
    // Clear input
    document.getElementById('newExamName').value = "";
    document.getElementById('newExamCode').value = "";
    
    // Reload data
    init(); 
  }
</script>

</body>
</html>