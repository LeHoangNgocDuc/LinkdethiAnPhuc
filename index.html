<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>KI·ªÇM TRA TR·ª∞C TUY·∫æN - AN PH√öC EDUCATION</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
    /* --- 1. C·∫§U H√åNH GIAO DI·ªÜN --- */
    :root { 
      --primary: #1e3a8a; --secondary: #2563eb; --accent: #f59e0b; 
      --bg: #f3f4f6; --white: #ffffff; --text: #1f2937; --border: #e5e7eb;
    }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    
    /* HEADER */
    header { 
      background: var(--white); padding: 10px 15px; height: 65px;
      display: flex; justify-content: space-between; align-items: center; 
      border-bottom: 1px solid var(--border); flex-shrink: 0; z-index: 10;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand img { height: 42px; width: 42px; border-radius: 50%; object-fit: cover; border: 2px solid var(--secondary); }
    .brand-text h1 { margin: 0; font-size: 0.95rem; color: var(--primary); text-transform: uppercase; font-weight: 800; line-height: 1.2; }
    .brand-text p { margin: 0; font-size: 0.7rem; color: #6b7280; font-weight: 500; }
    
    .btn-login { 
      background: #eff6ff; color: var(--primary); border: 1px solid #bfdbfe; 
      padding: 6px 12px; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 0.8rem; transition: 0.2s;
    }

    /* TABS */
    .tabs { display: flex; background: var(--white); border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .tab-btn { flex: 1; padding: 12px; border: none; background: none; font-weight: 600; color: #6b7280; cursor: pointer; position: relative; font-size: 0.9rem; }
    .tab-btn.active { color: var(--secondary); background: #f8fafc; }
    .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: var(--secondary); }

    /* LAYOUT */
    .main-container { flex: 1; display: flex; overflow: hidden; position: relative; }
    .sidebar { width: 320px; background: var(--white); border-right: 1px solid var(--border); overflow-y: auto; padding: 10px; display: flex; flex-direction: column; }
    .content-area { flex: 1; background: #f9fafb; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }

    /* TREE VIEW */
    ul { list-style: none; padding-left: 12px; margin: 0; }
    .caret { padding: 12px 10px; cursor: pointer; font-weight: 600; color: #374151; display: flex; align-items: center; border-radius: 6px; user-select: none; font-size: 0.95rem; border-bottom: 1px solid #f3f4f6; }
    .caret::before { content: "‚ñ∂"; margin-right: 8px; font-size: 0.7rem; color: #9ca3af; transition: 0.2s; }
    .caret-down::before { transform: rotate(90deg); color: var(--secondary); }
    .caret:hover { background: #f3f4f6; }
    .nested { display: none; margin-left: 8px; border-left: 2px solid #e5e7eb; }
    .active { display: block; }
    .item-leaf { padding: 12px 10px; margin: 4px 0; border-radius: 8px; font-size: 0.95rem; color: #4b5563; cursor: pointer; background: white; transition: 0.1s; border: 1px solid transparent; }
    .item-leaf:active { background: #e0e7ff; }
    .item-leaf.selected { background: var(--secondary); color: white; font-weight: 500; box-shadow: 0 4px 6px -2px rgba(37,99,235,0.3); border-color: var(--secondary); }
    .special-node > div { color: #be185d; font-weight: 800; }

    /* EXAM CARD */
    .exam-card { background: var(--white); width: 100%; max-width: 600px; padding: 20px; border-radius: 16px; box-shadow: 0 4px 15px -3px rgba(0,0,0,0.1); display: none; animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .exam-title { color: var(--primary); font-size: 1.25rem; margin: 0 0 5px 0; text-align: center; font-weight: 700; line-height: 1.3; }
    .exam-subtitle { text-align: center; color: #6b7280; margin-bottom: 20px; font-size: 0.9rem; }

    /* CODE BUTTONS */
    .code-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; }
    .code-wrapper { position: relative; }
    .code-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; border: 2px solid #e5e7eb; border-radius: 12px; background: #fff; cursor: pointer; transition: 0.2s; text-decoration: none; color: inherit; height: 100%; min-height: 80px; }
    .code-btn span { font-size: 1.8rem; margin-bottom: 5px; }
    .code-btn b { color: var(--primary); font-size: 1.1rem; font-family: monospace; }
    .code-btn:active { background: #eff6ff; border-color: var(--secondary); transform: scale(0.96); }
    
    .btn-delete { position: absolute; top: -8px; right: -8px; width: 28px; height: 28px; background: #ef4444; color: white; border-radius: 50%; border: none; font-weight: bold; cursor: pointer; display: none; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-size: 14px; z-index: 5; }
    .code-wrapper:hover .btn-delete.show { display: flex; }

    /* ADMIN PANEL */
    .admin-panel { margin-top: 25px; padding: 15px; background: #fffbeb; border: 1px solid #fcd34d; border-radius: 12px; display: none; }
    .admin-panel.show { display: block; }
    .admin-header { font-weight: bold; color: #b45309; margin-bottom: 10px; font-size: 0.9rem; text-transform: uppercase; }
    .input-row { display: flex; gap: 8px; margin-bottom: 10px; }
    input { flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; }
    button.btn-action { padding: 0 15px; border-radius: 8px; border: none; color: white; font-weight: 600; cursor: pointer; }
    .btn-save { background: #f59e0b; } .btn-add { background: #10b981; } .btn-create { background: #ef4444; width: 100%; padding: 12px; margin-top: 5px; }

    /* MOBILE RESPONSIVE */
    @media (max-width: 768px) {
      .main-container { flex-direction: column; }
      .sidebar { width: 100%; height: 40vh; border-right: none; border-bottom: 1px solid var(--border); padding: 5px; }
      .content-area { height: 60vh; padding: 15px; background: #fff; }
      .exam-card { padding: 15px; border: none; box-shadow: none; max-width: 100%; }
      .code-list { grid-template-columns: repeat(2, 1fr); }
      .btn-delete.show { display: flex; top: -10px; right: -10px; }
    }

    #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; color: var(--primary); font-weight: 600; flex-direction: column; }
    .spinner { width: 40px; height: 40px; border: 4px solid #bfdbfe; border-top-color: var(--secondary); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 10px; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .placeholder { margin-top: 60px; text-align: center; color: #9ca3af; }
    .placeholder div { font-size: 3rem; margin-bottom: 10px; opacity: 0.5; }
  </style>
</head>
<body>

<div id="loading"><div class="spinner"></div>ƒêang t·∫£i d·ªØ li·ªáu...</div>

<header>
  <div class="brand">
    <img src="https://raw.githubusercontent.com/LeHoangNgocDuc/LinkdethiAnPhuc/main/logo.jpg" alt="Logo">
    <div class="brand-text">
      <h1>AN PH√öC EDUCATION</h1>
      <p>Ki·ªÉm tra tr·ª±c tuy·∫øn</p>
    </div>
  </div>
  <button class="btn-login" id="loginBtn" onclick="toggleLogin()">üîí GV</button>
</header>

<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('regular')">Th∆∞·ªùng xuy√™n</button>
  <button class="tab-btn" onclick="switchTab('periodic')">ƒê·ªãnh k·ª≥ & Cu·ªëi c·∫•p</button>
</div>

<div class="main-container">
  <div class="sidebar" id="sidebarContent"></div>
  <div class="content-area">
    <div id="placeholder" class="placeholder"><div>üëà</div>Vui l√≤ng ch·ªçn b√†i thi</div>
    
    <div id="examCard" class="exam-card">
      <h2 id="examTitle" class="exam-title">Ti√™u ƒë·ªÅ b√†i thi</h2>
      <div class="exam-subtitle">Click v√†o m√£ ƒë·ªÅ ƒë·ªÉ <b>COPY</b> v√† <b>V√ÄO THI</b>:</div>
      <div id="codeList" class="code-list"></div>

      <div id="adminPanel" class="admin-panel">
        <div class="admin-header">üõ†Ô∏è QU·∫¢N L√ù ƒê·ªÄ THI</div>
        <div id="editNameGroup" style="display:none; margin-bottom:10px;">
           <div class="input-row"><input type="text" id="editNameInput" placeholder="S·ª≠a t√™n b√†i thi..."><button class="btn-action btn-save" onclick="saveName()">L∆∞u</button></div>
        </div>
        <div class="input-row"><input type="text" id="addCodeInput" placeholder="Th√™m m√£ (VD: 101)..."><button class="btn-action btn-add" onclick="addCode()">+ Th√™m</button></div>
        <div style="margin-top: 15px; border-top: 1px dashed #d97706; padding-top: 10px;">
           <label style="color:#b45309; display:block; margin-bottom:5px; font-weight:600;">‚ûï T·∫°o ƒê·ªÅ M·ªõi (V√†o m·ª•c n√†y)</label>
           <input type="text" id="newExamName" placeholder="T√™n ƒë·ªÅ m·ªõi..." style="margin-bottom:5px; width:100%">
           <input type="text" id="newExamCode" placeholder="M√£ ƒë·ªÅ ƒë·∫ßu ti√™n..." style="width:100%">
           <button class="btn-action btn-create" onclick="createNewExam()">T·∫°o Ngay</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Link API Google Apps Script
  const API_URL = "https://script.google.com/macros/s/AKfycbzxq3D8DnKbsXRkiO2z76gG0zz6fZIqEvQEVqXjDRjCGWx-o630qndwjNNsTi6A6LNf/exec";
  
  // Link trang l√†m b√†i (Trung T√¢m An Ph√∫c)
  const EXAM_PAGE_URL = "https://trungtamanphuc.io.vn";

  let regularData = [], periodicData = [], isAdmin = false, currentTab = 'regular', currentItem = null;

  async function callAPI(params) {
    const url = API_URL + "?" + new URLSearchParams(params).toString();
    try { const res = await fetch(url); return await res.json(); } catch (e) { console.error(e); return null; }
  }

  async function init() {
    const [reg, per] = await Promise.all([callAPI({ action: "getRegular" }), callAPI({ action: "getPeriodic" })]);
    if (reg) regularData = reg;
    if (per) periodicData = per;
    document.getElementById('loading').style.display = 'none';
    renderSidebar();
  }
  window.onload = init;

  function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    renderSidebar();
    document.getElementById('examCard').style.display = 'none';
    document.getElementById('placeholder').style.display = 'block';
    currentItem = null;
  }

  function renderSidebar() {
    const root = document.getElementById('sidebarContent');
    root.innerHTML = "";
    if (currentTab === 'regular') renderTree(regularData, root);
    else renderList(periodicData, root);
  }

  function renderTree(data, root) {
    if(!data) return;
    const tree = {};
    data.forEach(item => {
      if (!tree[item.grade]) tree[item.grade] = {};
      if (!tree[item.grade][item.chapter]) tree[item.grade][item.chapter] = [];
      tree[item.grade][item.chapter].push(item);
    });
    const ul = document.createElement('ul');
    for (let grade in tree) {
      let li = document.createElement('li');
      li.innerHTML = `<div class="caret" onclick="toggleNested(this)">‚ñ∂ ${grade}</div>`;
      let chapUl = document.createElement('ul');
      chapUl.className = "nested";
      for (let chap in tree[grade]) {
        let chapLi = document.createElement('li');
        chapLi.innerHTML = `<div class="caret" onclick="toggleNested(this)">‚ñ∂ ${chap}</div>`;
        let lessonUl = document.createElement('ul');
        lessonUl.className = "nested";
        tree[grade][chap].forEach(lesson => {
           let lessonLi = document.createElement('li');
           lessonLi.className = "item-leaf";
           lessonLi.innerText = lesson.lesson;
           lessonLi.onclick = () => selectExam(lesson, 'regular');
           lessonUl.appendChild(lessonLi);
        });
        chapLi.appendChild(lessonUl);
        chapUl.appendChild(chapLi);
      }
      li.appendChild(chapUl);
      ul.appendChild(li);
    }
    root.appendChild(ul);
  }

  function renderList(data, root) {
    if(!data) return;
    const order = ["To√°n 6", "To√°n 7", "To√°n 8", "To√°n 9", "TS10", "To√°n 10", "To√°n 11", "To√°n 12", "TNTHPT"];
    const grouped = {};
    data.forEach(i => { if(!grouped[i.category]) grouped[i.category]=[]; grouped[i.category].push(i); });
    const ul = document.createElement('ul');
    order.forEach(cat => {
      if (grouped[cat]) {
        let li = document.createElement('li');
        if (cat === "TS10" || cat === "TNTHPT") li.className = "special-node";
        li.innerHTML = `<div class="caret" onclick="toggleNested(this)">‚ñ∂ ${cat}</div>`;
        let subUl = document.createElement('ul');
        subUl.className = "nested";
        grouped[cat].forEach(exam => {
           let subLi = document.createElement('li');
           subLi.className = "item-leaf";
           subLi.innerText = exam.displayName;
           subLi.onclick = () => selectExam(exam, 'periodic');
           subUl.appendChild(subLi);
        });
        li.appendChild(subUl);
        ul.appendChild(li);
      }
    });
    root.appendChild(ul);
  }

  function toggleNested(elm) {
    elm.parentElement.querySelector(".nested").classList.toggle("active");
    elm.classList.toggle("caret-down");
  }

  function selectExam(item, type) {
    currentItem = item;
    currentItem.dataType = type;
    document.querySelectorAll('.item-leaf').forEach(el => el.classList.remove('selected'));
    event.target.classList.add('selected');
    document.getElementById('placeholder').style.display = 'none';
    document.getElementById('examCard').style.display = 'block';
    document.getElementById('examTitle').innerText = item.displayName || item.lesson;
    if(window.innerWidth < 768) document.querySelector('.content-area').scrollTop = 0;
    renderCodes(item.code);
    updateAdminUI();
  }

  function renderCodes(codeStr) {
    const div = document.getElementById('codeList');
    div.innerHTML = "";
    if (!codeStr) { div.innerHTML = `<div style="text-align:center;width:100%;color:#999;border:1px dashed #ccc;padding:10px;">Ch∆∞a c√≥ m√£ ƒë·ªÅ</div>`; return; }
    const codes = codeStr.toString().split(',').map(c=>c.trim()).filter(c=>c);
    
    codes.forEach(code => {
      let wrapper = document.createElement('div');
      wrapper.className = 'code-wrapper';
      let btn = document.createElement('div');
      btn.className = 'code-btn';
      btn.innerHTML = `<span>üìù</span><b>${code}</b>`;
      
      // LOGIC: COPY M√É -> M·ªû TRANG AN PH√öC
      btn.onclick = () => {
         navigator.clipboard.writeText(code).then(() => {
             if(confirm(`ƒê√£ copy m√£: ${code}\n\nNh·∫•n OK ƒë·ªÉ ƒë·∫øn trang l√†m b√†i.`)) {
                 window.open(EXAM_PAGE_URL, "_blank");
             }
         }).catch(() => {
             prompt("Copy th·ªß c√¥ng:", code);
             window.open(EXAM_PAGE_URL, "_blank");
         });
      };

      let del = document.createElement('button');
      del.className = "btn-delete " + (isAdmin ? 'show' : '');
      del.innerText = "X";
      del.onclick = (e) => { e.stopPropagation(); deleteCode(code); };
      wrapper.appendChild(btn);
      wrapper.appendChild(del);
      div.appendChild(wrapper);
    });
  }

  async function toggleLogin() {
    if (!isAdmin) {
      let p = prompt("M·∫≠t kh·∫©u Gi√°o Vi√™n:");
      if (!p) return;
      let res = await callAPI({ action: "login", pass: p });
      if (res && res.valid) {
        isAdmin = true;
        document.getElementById('loginBtn').innerText = "üîì ƒê√£ m·ªü";
        updateAdminUI();
        alert("ƒê√£ ƒëƒÉng nh·∫≠p th√†nh c√¥ng!");
      } else alert("Sai m·∫≠t kh·∫©u");
    } else {
      isAdmin = false;
      document.getElementById('loginBtn').innerText = "üîí GV";
      updateAdminUI();
    }
  }

  function updateAdminUI() {
    const panel = document.getElementById('adminPanel');
    const dels = document.querySelectorAll('.btn-delete');
    if (isAdmin) {
      panel.classList.add('show');
      dels.forEach(b => b.classList.add('show'));
      if(currentItem && currentItem.dataType === 'periodic') {
         document.getElementById('editNameGroup').style.display = 'block';
         document.getElementById('editNameInput').value = currentItem.displayName || "";
      } else {
         document.getElementById('editNameGroup').style.display = 'none';
      }
    } else {
      panel.classList.remove('show');
      dels.forEach(b => b.classList.remove('show'));
    }
  }

  async function addCode() {
    let code = document.getElementById('addCodeInput').value.trim();
    if(!code) return;
    let newCodes = currentItem.code ? currentItem.code + "," + code : code;
    let sheet = currentItem.dataType === 'periodic' ? 'PeriodicData' : 'RegularData';
    await callAPI({ action: "updateCode", sheet: sheet, row: currentItem.row, code: newCodes });
    currentItem.code = newCodes;
    renderCodes(newCodes);
    document.getElementById('addCodeInput').value = "";
    alert("ƒê√£ th√™m!");
  }

  async function deleteCode(code) {
    if(!confirm("X√≥a m√£ n√†y?")) return;
    let codes = currentItem.code.split(',').map(c=>c.trim()).filter(c=>c!=code).join(",");
    let sheet = currentItem.dataType === 'periodic' ? 'PeriodicData' : 'RegularData';
    await callAPI({ action: "updateCode", sheet: sheet, row: currentItem.row, code: codes });
    currentItem.code = codes;
    renderCodes(codes);
  }

  async function saveName() {
    let name = document.getElementById('editNameInput').value.trim();
    if(!name) return;
    await callAPI({ action: "updateName", row: currentItem.row, newName: name });
    currentItem.displayName = name;
    document.getElementById('examTitle').innerText = name;
    renderSidebar();
    alert("ƒê√£ l∆∞u t√™n!");
  }

  async function createNewExam() {
    if(!currentItem) { alert("Ch·ªçn m·ª•c tr∆∞·ªõc!"); return; }
    let name = document.getElementById('newExamName').value.trim();
    let code = document.getElementById('newExamCode').value.trim();
    if(!name) return;
    let sheet = currentItem.dataType === 'periodic' ? 'PeriodicData' : 'RegularData';
    let cat = currentItem.category || currentItem.grade;
    let type = currentItem.examType || currentItem.chapter;
    await callAPI({ action: "addExam", sheet: sheet, cat: cat, type: type, name: name, code: code });
    alert("ƒê√£ t·∫°o!");
    document.getElementById('newExamName').value = "";
    document.getElementById('newExamCode').value = "";
    init();
  }
</script>

</body>
</html>
